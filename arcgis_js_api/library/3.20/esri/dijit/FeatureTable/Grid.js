// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.20/esri/copyright.txt for details.
//>>built
require({cache:{"url:esri/dijit/FeatureTable/templates/Grid.html":'\x3cdiv\x3e\r\n  \x3cdiv class\x3d"${css.borderContainer}" data-dojo-attach-point\x3d "_gridBorderContainerNode" data-dojo-type\x3d"dijit/layout/BorderContainer" gutters\x3d"false"\x3e\r\n    \x3cdiv class\x3d"${css.contentPane} ${css.menu}" data-dojo-attach-point\x3d "_gridHeaderNode" data-dojo-type\x3d"dijit/layout/ContentPane" data-dojo-props\x3d"region: \'top\'"\x3e\r\n      \x3cdiv class\x3d"${css.menuItem} ${css.loadingIndicator} ${css.hidden}" data-dojo-attach-point\x3d "_gridLoadingIndicatorNode"\x3e\x3c/div\x3e\r\n      \x3cdiv class\x3d"${css.menuItem} ${css.menuOptions}" data-dojo-attach-point\x3d "_menuNode" \x3e\r\n        \x3cdiv data-dojo-attach-point\x3d "_gridMenuNode"\x3e\x3c/div\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv class\x3d"${css.menuItem} ${css.title}" data-dojo-attach-point\x3d "_gridTitleNode"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"${css.contentPane}" data-dojo-attach-point\x3d "_gridContentPaneNode" data-dojo-type\x3d"dijit/layout/ContentPane" data-dojo-props\x3d"region: \'center\'"\x3e\r\n      \x3cdiv class\x3d"${css.grid}" data-dojo-attach-point\x3d"_gridNode"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e'}});
define("esri/dijit/FeatureTable/Grid","../../kernel ./dataUtils ./dialogUtils dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/aspect dojo/has dojo/keys dojo/on dojo/string dojo/dom-class dojo/dom-construct dojo/Deferred dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dijit/_WidgetBase dijit/a11yclick dijit/focus dijit/Menu dijit/MenuItem dijit/Tooltip dijit/form/Button dijit/form/DateTextBox dijit/form/DropDownButton dijit/form/NumberTextBox dijit/form/Select dijit/form/TimeTextBox dijit/form/ValidationTextBox dijit/layout/BorderContainer dijit/layout/ContentPane dgrid/OnDemandGrid dgrid/Selection dgrid/selector dgrid/Keyboard dgrid/editor dgrid/extensions/Pagination dgrid/extensions/DijitRegistry dgrid/extensions/ColumnHider dgrid/extensions/ColumnResizer dojo/i18n!../../nls/jsapi dojo/text!./templates/Grid.html".split(" "),
function(P,h,G,H,f,p,I,Q,B,v,z,q,r,R,D,S,T,x,U,J,y,V,ja,K,W,E,F,X,Y,ka,la,Z,aa,ba,ca,L,da,ea,fa,ga,ha,ia){D=H([T,D,S],{declaredClass:"esri.dijit.FeatureTable.Grid",baseClass:"esri-feature-table-grid",templateString:ia,map:null,layer:null,layerInfo:null,idProperty:"id",sort:null,defaultSort:null,filterIds:null,where:null,batchCount:50,editable:!1,editOn:"dblclick, keypress",css:null,showAttachments:!1,showRelatedRecords:!1,showCyclicalRelationships:!1,showStatistics:!1,showFieldDetails:!1,showGridHeader:!0,
showGridMenu:!0,showFilterMenuItems:!0,showDefaultSortMenuItem:!0,showFeatureCount:!0,showDataTypes:!1,showColumnHeaderTooltips:!1,showColumnHider:!1,syncSelection:!1,menuFunctions:null,columnMenuFunctions:null,gridOptions:null,dateOptions:null,visibleLayerIds:null,loaded:!1,store:null,columns:null,fieldInfos:null,customFieldInfos:null,noDataMessage:"",featureCount:0,selectedFeatureCount:0,selectedRows:null,selectedRowIds:null,optionsMenu:null,optionsMenuAnchor:null,columnMenu:null,rollbackInfos:null,
attachmentInfos:null,relatedRecordInfos:null,relatedRecordCounts:null,_i18nStrings:ha.widgets.FeatureTable,_numericFieldTypes:["esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeSmallInteger"],_unsupportedFieldTypes:["esriFieldTypeGUID","esriFieldTypeRaster","esriFieldTypeBlob","esriFieldTypeGeometry","esriFieldTypeXML"],_activeEditors:null,_relationshipColumnLimit:5,_nullConstant:"ft_null",_watchers:null,_columnHiderButton:null,_tableTitle:null,_previousSelectedRowIds:null,
postMixInProperties:function(){this.inherited(arguments);this.set({sort:{},columns:[],fieldInfos:[],selectedRows:[],selectedRowIds:[],rollbackInfos:{},attachmentInfos:{},relatedRecordInfos:{},relatedRecordCounts:{},_watchers:[],_previousSelectedRowIds:[]})},startup:function(){this.inherited(arguments);this.dGrid=this._createGrid();this._cleanUpGrid();this.dGrid.startup();this.dGrid.resize();this.showLoadingIndicator();this.updateHeaderText();this.showGridHeader||this.hideHeader();this._generateOptionsMenu();
this.showGridMenu||this.hideOptionsMenu();this._generateColumnHiderButton();this.showColumnHider||this.hideColumnHiderButton();this._addGridListeners()},destroy:function(){this.inherited(arguments);this.optionsMenu&&this.optionsMenu.destroy();this.columnMenu&&this.columnMenu.destroyRecursive();p.forEach(this._watchers,function(a){a.remove()})},resize:function(){this._gridBorderContainerNode&&this._gridBorderContainerNode.resize();this._gridHeaderNode&&this._gridHeaderNode.resize();this._gridContentPaneNode&&
this._gridContentPaneNode.resize();this.dGrid&&this.dGrid.resize()},setHeaderTitle:function(a){this._gridTitleNode&&(this._gridTitleNode.innerHTML=a)},showHeader:function(){q.remove(this._gridHeaderNode.domNode,this.css.hidden);this.resize()},hideHeader:function(){q.add(this._gridHeaderNode.domNode,this.css.hidden);this.resize()},showLoadingIndicator:function(){this._gridLoadingIndicatorNode&&q.remove(this._gridLoadingIndicatorNode,this.css.hidden)},hideLoadingIndicator:function(){this._gridLoadingIndicatorNode&&
q.add(this._gridLoadingIndicatorNode,this.css.hidden)},showOptionsMenu:function(){this._menuNode&&q.remove(this._menuNode,this.css.hidden)},hideOptionsMenu:function(){this._menuNode&&q.add(this._menuNode,this.css.hidden)},updateNoDataMessage:function(a){this.dGrid.set("noDataMessage",a)},showColumnHiderMenu:function(){this.gridOptions.columnHider&&this.dGrid._toggleColumnHiderMenu()},showColumnHiderButton:function(){this._columnHiderButton&&q.remove(this._columnHiderButton,this.css.hidden)},hideColumnHiderButton:function(){this._columnHiderButton&&
q.add(this._columnHiderButton,this.css.hidden)},refresh:function(){this.dGrid&&this.dGrid.refresh();0===this.featureCount&&this.hideLoadingIndicator();this._updateSelection().then(f.hitch(this,this.updateHeaderText))},getRowById:function(a){return this.dGrid.row(a)||{}},getRowDataById:function(a){return(a=this.getRowById(a))&&a.data?a.data:{}},emptyStore:function(){this.updateNoDataMessage("");this.updateStore(null)},updateStore:function(a){this.set("store",a);this.dGrid.set("store",a)},updateSort:function(a){this.set("sort",
a[0]);this.dGrid.set("sort",a)},updateSelectionMode:function(a){this.dGrid.set("selectionMode",a)},getColumns:function(){return this.dGrid.columns},styleColumn:function(a,b){return this.dGrid.styleColumn(a,b)},clearSelection:function(){this.dGrid.clearSelection();this._updateSelection().then(f.hitch(this,this.updateHeaderText));this.emit("clear-selection")},centerOnSelection:function(){var a=this.map,b=this.selectedRowIds;if(a&&b&&0!==b.length)return h.queryLayerForFeatures({layer:this.layer,ids:b}).then(f.hitch(function(b){(b=
b.features)&&0<b.length&&a.setExtent(h.calculateExtentFromFeatures(b))}))},selectRows:function(a,b,d){var c=this.dGrid,e=[],g;this._closeCellEditors();this.clearSelection();a instanceof Array?(p.forEach(a,function(a){c._select(a);e.push(this.getRowById(a))},this),g=a[0]):(c._select(a),g=a,e=[this.getRowById(a)]);this._updateSelection().then(f.hitch(this,function(){this.updateHeaderText();d||this.emit("row-select",{rows:e,grid:this.dGrid});b&&this._scrollToRow(g)}))},_createGrid:function(){return new (this._generateGridClass())({columns:this.columns,
sort:[this.defaultSort],noDataMessage:this.noDataMessage,selectionMode:this.gridOptions.selectionMode,allowSelectAll:this.gridOptions.allowSelectAll,allowTextSelection:this.gridOptions.allowTextSelection,cellNavigation:this.gridOptions.cellNavigation,keepScrollPosition:this.gridOptions.keepScrollPosition,pageSizeOptions:this.gridOptions.pageSizeOptions,queryRowsOverlap:this.gridOptions.queryRowsOverlap,minRowsPerPage:this.batchCount,maxRowsPerPage:this.batchCount,pagingDelay:this.pagingDelay,query:f.hitch(this,
this._getQueryForGrid)},this._gridNode)},_generateGridClass:function(){var a=[ea,Z,aa,L,ba,ca];this.gridOptions.pagination&&a.push(da);this.gridOptions.columnHider&&a.push(fa);this.gridOptions.columnResizer&&a.push(ga);return H(a)},_getQueryForGrid:function(a){return!this.filterIds||-1!==p.indexOf(this.filterIds,a[this.idProperty])},_cleanUpGrid:function(){var a=this.dGrid,b=I.before(a,"removeRow",f.hitch(this,function(b){p.forEach(this.columns.length,function(d,c){var e=a.cell(b,c).element;(e=(e.contents||
e).widget)&&e.destroyRecursive()})})),d=I.after(a,"renderHeader",function(){a._sortListener.remove()});this._watchers.push(b,d)},_setUpColumns:function(a){a=this._generateFieldInfos(a);var b=this._generateColumns(a);this.set({columns:b,fieldInfos:a});this.dGrid.set("columns",b);return{fieldInfos:a,columns:b}},_generateFieldInfos:function(a){if(a&&0!==a.length&&this.layerInfo){a=this._orderFieldsForDisplay(a);var b=this.layer,d=this.layerInfo,c=this.idProperty,e=[],g=this.customFieldInfos,f=this.outFields,
k=this.hiddenFields,l,n,u,C,M,t,A,N,r,v,O,x,q,w;p.forEach(a,function(a){u=a.length||null;q=h.findFirst(b.fields,"name",a.name)||{};l=(w=h.findFirst(g,"name",a.name)||h.findFirst(g,"fieldName",a.name))&&(w.label||w.alias)||q.alias;M=b.getDomain&&b.getDomain(a.name)?b.getDomain(a.name):!1;C=!(!d.typeIdField||a.name!==d.typeIdField);t=d.types&&p.some(d.types,function(b){if(b.domains&&b.domains[a.name]&&b.domains[a.name].name)return!0});A=!this._getFieldVisibility({field:a,hiddenFields:k,customFieldInfo:w,
outFields:f});O=d.editable&&d.editCapabilities.canUpdate;x=w&&("undefined"!==typeof w.editable&&!1!==q.editable||"undefined"!==typeof w.isEditable&&!1!==q.isEditable);N=O&&a.name!==c&&q&&"undefined"!==q.editable?x?!!w.editable||!!w.isEditable:!!q.editable:!1;n=w&&w.format?w.format:null;r=!!q.nullable;v=w&&(w.dateOptions||w.format&&w.format.dateFormat)||null;e.push({name:a.name,alias:l,length:u,type:a.type,hidden:A,editable:N,nullable:r,domain:M,typeId:C,subtypeDomain:t,format:n,dateOptions:v})},this);
p.every(e,function(a){return a.hidden})&&(h.findFirst(e,"name",this.idProperty).hidden=!1);this.showRelatedRecords&&this._generateRelatedRecordFieldInfos({fieldInfos:e,relationships:b.relationships});this.showAttachments&&e.push({alias:this._i18nStrings.photosAndFiles,name:"esriAttachments",type:"esriAttachments",editable:d.editable});return e}},_destroyColumns:function(){this.dGrid&&this.dGrid._destroyColumns()},_getFieldVisibility:function(a){var b=a.field,d=a.outFields,c=a.customFieldInfo;a=-1!==
p.indexOf(a.hiddenFields,b.name);c=!(!c||!1!==c.visible);d="*"!==d[0]&&-1===p.indexOf(d,b.name);b="esriFieldTypeOID"===b.type||"esriFieldTypeGlobalID"===b.type;return!(a||b&&(c||d)||c||d)},_applyEdits:function(a){var b=a.row,d=a.rollbackInfo;this.showLoadingIndicator();d&&this._updateRollbackInfos(d);return h.applyEditsFromRow({layer:this.layer,idProperty:this.idProperty,row:b}).then(f.hitch(this,function(a){var c=a.updates||[];c&&c.length&&p.forEach(c,function(a){a.success||(a.error?this.emit("error",
{message:a.error}):this.emit("error",{message:this._i18nStrings.errorUpdateFailed}),d?(b=this.getRowDataById(d.rowId),b[d.fieldName]=d.oldValue,this.dGrid.updateDirty(d.rowId,d.fieldName,d.oldValue),this.refresh()):this.emit("error",{message:this._i18nStrings.errorRollback}))});this.hideLoadingIndicator();this.emit("edits-complete",a)})).otherwise(f.hitch(this,function(){d&&(b=this.getRowDataById(d.rowId),b[d.fieldName]=d.oldValue,this.dGrid.updateDirty(d.rowId,d.fieldName,d.oldValue),this.refresh());
this.hideLoadingIndicator();this.emit("error",{message:this._i18nStrings.errorUpdateFailed})}))},_updateRollbackInfos:function(a){if(a){var b=a.rowId;this.rollbackInfos[b]||(this.rollbackInfos[b]=[]);this.rollbackInfos[b].push(a)}},_updateSelection:function(){var a=this.dGrid.selection,b=new R,d=[],c=[],e,g;for(g in a)a.hasOwnProperty(g)&&(e=parseInt(g,10),c.push(e),e=this.dGrid.row(e),(e=e.data)&&d.push(e));a={selectedRows:d,selectedRowIds:c,selectedFeatureCount:c.length};this.set(a);b.resolve(a);
return b},_scrollToRow:function(a){var b=this.store,d=this.dGrid,c=d.row(a),e=this.sort;if(c&&b)if(c.element)c.element.scrollIntoView();else if(a=b.data[a]||c.data)b=e&&e.attribute===this.idProperty&&e.descending?b.data.length-p.indexOf(b.data,a):p.indexOf(b.data,a),d.scrollTo({x:0,y:d.rowHeight*b-d.rowHeight}),c.element?c.element.scrollIntoView():setTimeout(function(){c.element&&c.element.scrollIntoView()},200)},_generateColumns:function(a){a=f.clone(a)||[];var b=[];p.forEach(a,function(a){"esriAttachments"===
a.type?b.push(this._generateAttachmentsColumn(a)):"esriRelatedRecords"===a.type?b.push(this._generateRelatedRecordsColumn(a)):"esriFieldTypeDate"===a.type?this.dateOptions.timeEnabled?b.push(this._generateDateTimeColumn(a)):b.push(this._generateDateColumn(a)):a.typeId?b.push(this._generateTypeColumn(a)):a.domain?b.push(this._generateDomainColumn(a)):a.subtypeDomain&&!a.typeId?b.push(this._generateSubtypeDomainColumn(a)):-1<p.indexOf(this._numericFieldTypes,a.type)?b.push(this._generateNumberColumn(a)):
-1===p.indexOf(this._unsupportedFieldTypes,a.type)&&b.push(this._generateStringColumn(a))},this);return b},_orderFieldsForDisplay:function(a){var b=this.outFields,d=this.idProperty,c=[];b&&"*"===b[0]?c=f.clone(a):(h.isValueEmpty(d)||-1!==p.indexOf(b,d)||c.push(h.findFirst(a,"name",d)),p.forEach(b,function(b){var e=h.findFirst(a,"name",b)||null;e&&b.name!==d&&-1===p.indexOf(c,e)&&c.push(e)}),p.forEach(a,function(a){-1===p.indexOf(c,a)&&c.push(f.clone(a))}));return c},_generateDateColumn:function(a){var b=
a.dateOptions||this.dateOptions;return new L({label:a.alias,field:a.name,type:a.type,editorArgs:{required:!a.nullable,constraints:{datePattern:a.dateOptions&&a.dateOptions.datePattern?a.dateOptions.datePattern:this.dateOptions.datePattern}},className:this.css.dateValue,editOn:this.editOn,hidden:a.hidden,formatter:function(d){return h.isValueEmpty(d)?null:h.formatDateForLocale({dateOptions:b,timestamp:d,fieldInfo:a})},get:function(b){return h.isValueEmpty(b[a.name])?null:new Date(b[a.name])},renderHeaderCell:f.hitch(this,
function(){return this._getColumnHeaderCellContent({fieldInfo:a})})},K)},_generateDateTimeColumn:function(a){var b=a.dateOptions||this.dateOptions;return{label:a.alias,field:a.name,type:a.type,hidden:a.hidden,className:this.css.dateValue,get:f.hitch(this,function(d){return h.isValueEmpty(d[a.name])?null:h.formatDateForLocale({dateOptions:b,timestamp:new Date(d[a.name]),fieldInfo:a})}),renderCell:f.hitch(this,function(b,c,e){c=r.create("div",{innerHTML:h.isValueEmpty(c)?"":c},e);this._setUpDateTimeCell({row:b,
cellNode:e,fieldInfo:a,container:c})}),renderHeaderCell:f.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:a})})}},_generateDomainColumn:function(a){return{label:a.alias,field:a.name,type:a.type,hidden:a.hidden,get:function(b){return h.getDomainValueFromRow({fieldInfo:a,row:b})},renderHeaderCell:f.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:a})}),renderCell:f.hitch(this,function(b,d,c){var e=r.create("div");if(a.domain.codedValues)d=this._formatStringCellContent({fieldInfo:a,
value:d}),this._setUpCodedValueDomainCell({row:b,cellNode:c,fieldInfo:a,container:e});else if("range"===a.domain.type)d=this._formatNumberCellContent({fieldInfo:a,value:d}),this._setUpRangeDomainCell({row:b,cellNode:c,fieldInfo:a,container:e});else{this.emit("error",{message:this._i18nStrings.errorDomainType});return}e.innerHTML=d;r.place(e,c)})}},_generateTypeColumn:function(a){return{label:a.alias,field:a.name,type:a.type,hidden:a.hidden,get:f.hitch(this,function(b){var d=h.getTypeValueFromRow({layerInfo:this.layerInfo,
fieldInfo:a,row:b});return h.isValueEmpty(d)?b[a.name]:d}),renderCell:f.hitch(this,function(b,d,c){d=this._formatStringCellContent({fieldInfo:a,value:d});d=r.create("div",{innerHTML:d},c);this._setUpTypeCell({row:b,cellNode:c,fieldInfo:a,container:d})}),renderHeaderCell:f.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:a})})}},_generateSubtypeDomainColumn:function(a){return{label:a.alias,field:a.name,type:a.type,hidden:a.hidden,editOn:this.editOn,editor:"text",get:f.hitch(this,
function(b){return h.getSubtypeDomainValue({layerInfo:this.layerInfo,fieldInfo:a,row:b})}),renderHeaderCell:f.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:a})}),renderCell:f.hitch(this,function(b,d,c){d=this._formatStringCellContent({fieldInfo:a,value:d});d=r.create("div",{innerHTML:d},c);this._setUpSubtypeDomainCell({row:b,cellNode:c,fieldInfo:a,container:d})})}},_generateNumberColumn:function(a){return{label:a.alias,field:a.name,type:a.type,hidden:a.hidden,renderHeaderCell:f.hitch(this,
function(){return this._getColumnHeaderCellContent({fieldInfo:a})}),renderCell:f.hitch(this,function(b,d,c){d=this._formatNumberCellContent({fieldInfo:a,value:d});d=r.create("div",{innerHTML:d},c);this._setUpNumberCell({row:b,cellNode:c,fieldInfo:a,container:d})})}},_generateStringColumn:function(a){return{label:a.alias,field:a.name,type:a.type,hidden:a.hidden,renderHeaderCell:f.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:a})}),renderCell:f.hitch(this,function(b,d,c){d=
this._formatStringCellContent({fieldInfo:a,value:d});d=r.create("div",{innerHTML:d},c);this._setUpStringCell({row:b,cellNode:c,fieldInfo:a,container:d})})}},_generateAttachmentsColumn:function(a){var b=this.layerInfo||{};return{label:a.alias,field:a.name,type:"esriAttachments",get:f.hitch(this,function(a){a=this.attachmentInfos[a[this.idProperty]];var c;c=b.queryAttachmentsSupported?0:null;return a&&a.attachments?a.attachments.length:c}),renderCell:f.hitch(this,function(b,c,e){this._generateAttachmentsCell({row:b,
fieldInfo:a,cellValue:c,cellNode:e})}),renderHeaderCell:f.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:a,cssClass:this.css.attachmentsTitle})})}},_generateRelatedRecordsColumn:function(a){return{label:a.alias,field:a.name,type:"esriRelatedRecords",hidden:a.hidden,get:f.hitch(this,function(b){return this._getRelatedRecordsCount({featureId:b[this.idProperty],relationshipId:a.relationship.id})}),renderCell:f.hitch(this,function(b,d,c){this._generateRelatedRecordsCell({row:b,
fieldInfo:a,cellValue:d,cellNode:c})}),renderHeaderCell:f.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:a,cssClass:this.css.relatedRecordsTitle})})}},_closeCellEditors:function(){p.forEach(this._activeEditors,function(a){a.widget.onBlur()});this.set("_activeEditors",[])},_getColumnHeaderCellContent:function(a){var b=a.fieldInfo,d=a.cssClass||null;a=this.css;var c=a.lockedIconContainer+" "+a.lockedIcon,e="esriRelatedRecords"===b.type||"esriAttachments"===b.type,g;g=r.create("div",
{className:a.columnHeader});d=d?a.columnHeaderTitle+" "+d:a.columnHeaderTitle;!b.editable&&this.editable&&this.layerInfo.editable&&r.create("span",{className:c},g);r.create("div",{innerHTML:b.alias||b.name,className:d},g);r.create("div",{className:a.columnHeaderClear},g);this.showColumnHeaderTooltips&&this.own(new V({connectId:[g],label:b.alias||b.name}));this.showDataTypes&&!e&&(r.create("div",{innerHTML:b.type.replace("esriFieldType",""),className:a.columnHeaderType},g),r.create("div",{className:a.columnHeaderClear},
g));return g},_setUpNumberCell:function(a){var b=a.row,d=a.cellNode,c=a.fieldInfo,e=a.container,g=this.idProperty,m=h.isIntegerFieldType(c.type)?0:"0,20",k,l;v(d,this.editOn,f.hitch(this,function(){if(this.editable&&c.editable){var a=h.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);if(this.editOn!=x||a)l&&l.destroy(),this._closeCellEditors(),e.innerHTML="",l=new E({value:b[c.name],required:!c.nullable,constraints:{places:m}}),l.placeAt(e),l.focus(),l.textbox.select(),this.emit("editor-show",
{cell:d,editor:l,grid:this}),l.on("blur",f.hitch(this,function(){e.innerHTML=this._formatNumberCellContent({fieldInfo:c,value:b[c.name]});d.focus()})),l.on("keydown",function(a){a.keyCode===B.ENTER&&l.isValid()&&l.focusNode.blur()}),l.on("change",f.hitch(this,function(a){k={fieldName:c.name,oldValue:b[c.name],rowId:b[g],row:b};if(""===a||isNaN(a))a=null;l.isValid()?(b[c.name]=a,e.innerHTML=this._formatNumberCellContent({fieldInfo:c,value:a}),this._applyEdits({row:b,rollbackInfo:k})):e.innerHTML=this._formatNumberCellContent({fieldInfo:c,
value:b[c.name]});this.emit("editor-hide",{cell:d,editor:l,grid:this});l.destroy()})),this._activeEditors.push({id:b[g],widget:l})}}))},_setUpDateTimeCell:function(a){var b=a.row,d=a.fieldInfo,c=a.container,e=this.idProperty,g,m,k,l,n,u,C;v(a.cellNode,this.editOn,f.hitch(this,function(){if(this.editable&&d.editable){var a=h.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);if(this.editOn!=x||a){m&&m.destroy();k&&k.destroy();this._closeCellEditors();c.innerHTML="";l=d.dateOptions&&
d.dateOptions.datePattern?d.dateOptions.datePattern:this.dateOptions.datePattern;n=d.dateOptions&&d.dateOptions.timePattern?d.dateOptions.timePattern:this.dateOptions.timePattern;g=h.isValueEmpty(b[d.name])?null:new Date(b[d.name]);m=new K({value:g,constraints:{datePattern:l}});k=new X({value:g,constraints:{timePattern:n}});m.placeAt(c);k.placeAt(c);m.focus();m.textbox.select();m.on("change",f.hitch(this,function(a){if(m.isValid()){var c=k.getValue();C={fieldName:d.name,oldValue:b[d.name],rowId:b[e],
row:b};null===a||""===a?(k.setValue(null),b[d.name]=null):(null===c&&(c=new Date(0,0),k.setValue(c)),u=h.getCombinedDateTime(a,c).getTime(),b[d.name]=u,this._applyEdits({row:b,rollbackInfo:C}))}}));k.on("change",f.hitch(this,function(a){if(k.isValid()){var c=m.getValue();C={fieldName:d.name,oldValue:b[d.name],rowId:b[e],row:b};null===a||""===a?(m.setValue(null),b[d.name]=null):(null===c&&(c=new Date(0,0),m.setValue(c)),u=h.getCombinedDateTime(c,a).getTime(),b[d.name]=u,this._applyEdits({row:b,rollbackInfo:C}))}}));
var t=U.watch("activeStack",f.hitch(this,function(a,g,f){-1===p.indexOf(g,m.id)&&-1===p.indexOf(g,k.id)||-1!==p.indexOf(f,m.id)||-1!==p.indexOf(f,k.id)||(t.remove(),g=m.getValue(),f=k.getValue(),a={fieldName:d.name,oldValue:b[d.name],rowId:b[e],row:b},k.isValid()&&m.isValid()?(g&&f?(g=h.getCombinedDateTime(g,f).getTime(),c.innerHTML=h.formatDateForLocale({dateOptions:this.dateOptions,timestamp:new Date(g),fieldInfo:d})):(g=null,c.innerHTML=""),b[d.name]=g,this._applyEdits({row:b,rollbackInfo:a})):
c.innerHTML=h.formatDateForLocale({dateOptions:this.dateOptions,timestamp:b[d.name],fieldInfo:d}))}))}}}))},_setUpCodedValueDomainCell:function(a){var b=a.row,d=a.cellNode,c=a.fieldInfo,e=a.container,g=this.idProperty,m=[],k,l,n;p.forEach(c.domain.codedValues,function(a){b[c.name]===a.code?m.push({label:a.name,value:a.code,selected:!0}):m.push({label:a.name,value:a.code})});h.isValueEmpty(b[c.name])&&c.nullable?m.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0}):h.isValueEmpty(b[c.name])&&
!c.nullable?m.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0,disabled:!0}):c.nullable&&m.push({label:this._i18nStrings.empty,value:this._nullConstant});v(d,this.editOn,f.hitch(this,function(){if(this.editable&&c.editable){var a=h.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);if(this.editOn!=x||a)n&&n.destroy(),this._closeCellEditors(),e.innerHTML="",n=new F({options:m,"class":this.css.select,style:{width:"100%"}}),n.placeAt(e),n.focus(),this.emit("editor-show",
{cell:d,editor:n,grid:this}),n.on("blur",f.hitch(this,function(){var a=h.getDomainValueFromRow({fieldInfo:c,row:b});e.innerHTML=this._formatStringCellContent({fieldInfo:c,value:a})})),n.on("keydown",function(a){a.keyCode===B.ENTER&&n.focusNode.blur()}),n.on("change",f.hitch(this,function(a){l={fieldName:c.name,oldValue:b[c.name],rowId:b[g],row:b};a===this._nullConstant&&(a=null);b[c.name]=a;k=h.getDomainValueFromRow({fieldInfo:c,row:b});e.innerHTML=this._formatStringCellContent({fieldInfo:c,value:k});
this._applyEdits({row:b,rollbackInfo:l});this.emit("editor-hide",{cell:d,editor:n,grid:this});n.destroy()})),this._activeEditors.push({id:b[g],widget:n})}}))},_setUpRangeDomainCell:function(a){var b=a.row,d=a.cellNode,c=a.fieldInfo,e=a.container,g=c.domain.minValue,m=c.domain.maxValue,k=this.idProperty,l=h.isIntegerFieldType(c.type)?0:"0,20",n,p;v(d,this.editOn,f.hitch(this,function(){if(this.editable&&c.editable){var a=h.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);if(this.editOn!=
x||a)n&&n.destroy(),this._closeCellEditors(),e.innerHTML="",n=new E({value:b[c.name],required:!c.nullable,constraints:{min:g,max:m,places:l}}),n.placeAt(e),n.focus(),n.textbox.select(),this.emit("editor-show",{cell:d,editor:n,grid:this}),n.on("blur",f.hitch(this,function(){e.innerHTML=this._formatNumberCellContent({fieldInfo:c,value:b[c.name]})})),n.on("keydown",function(a){a.keyCode===B.ENTER&&n.isValid()&&n.focusNode.blur()}),n.on("change",f.hitch(this,function(a){p={fieldName:c.name,oldValue:b[c.name],
rowId:b[k],row:b};n.isValid()?(b[c.name]=a,e.innerHTML=this._formatNumberCellContent({fieldInfo:c,value:a}),this._applyEdits({row:b,rollbackInfo:p})):e.innerHTML=this._formatNumberCellContent({fieldInfo:c,value:b[c.name]});this.emit("editor-hide",{cell:d,editor:n,grid:this});n.destroy()})),this._activeEditors.push({id:b[k],widget:n})}}))},_setUpTypeCell:function(a){var b=a.row,d=a.cellNode,c=a.fieldInfo,e=a.container,g=this.idProperty,m=this.layerInfo,k=m.types,l,n,u;v(d,this.editOn,f.hitch(this,
function(){if(this.editable&&c.editable){var a=h.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds),r=b[c.name],t=[],v=h.isValueEmpty(h.getTypeValueFromRow({layerInfo:this.layerInfo,fieldInfo:c,row:b}));if(this.editOn!=x||a)u&&u.destroy(),this._closeCellEditors(),p.forEach(k,function(a){b[c.name]===a.id?t.push({label:a.name,value:a.id,selected:!0}):t.push({label:a.name,value:a.id})}),h.isValueEmpty(b[c.name])?t.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0,
disabled:!0}):v&&t.push({label:r,value:r,selected:!0,disabled:!0}),e.innerHTML="",u=new F({options:t,"class":this.css.select,style:{width:"100%"}}),u.placeAt(e),u.focus(),this.emit("editor-show",{cell:d,editor:u,grid:this}),u.on("blur",f.hitch(this,function(){var a=h.getTypeValueFromRow({layerInfo:m,fieldInfo:c,row:b});e.innerHTML=this._formatStringCellContent({fieldInfo:c,value:a||r})})),u.on("keydown",function(a){a.keyCode===B.ENTER&&u.focusNode.blur()}),u.on("change",f.hitch(this,function(a){n=
{fieldName:c.name,oldValue:b[c.name],rowId:b[g],row:b};a===this._nullConstant&&(a=null);b[c.name]=a;l=h.getTypeValueFromRow({layerInfo:this.layerInfo,fieldInfo:c,row:b});e.innerHTML=this._formatStringCellContent({fieldInfo:c,value:l});this._applyEdits({row:b,rollbackInfo:n});this.emit("editor-hide",{cell:d,editor:u,grid:this.grid});u.destroy()})),this._activeEditors.push({id:b[g],widget:u})}}))},_setUpSubtypeDomainCell:function(a){var b=a.row,d=a.cellNode,c=a.fieldInfo,e=a.container,g=this.idProperty,
m=this.layerInfo,k=m.types,l,n,u,r,q,t,A,y,z;v(d,this.editOn,f.hitch(this,function(){if(this.editable&&c.editable){var a=h.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);if(this.editOn!=x||a)q&&q.destroy(),t&&t.destroy(),this._closeCellEditors(),l=[],e.innerHTML="",n=h.findFirst(k,"id",b[m.typeIdField]),(u=n.domains[c.name])?(A=n.domains[c.name].codedValues,y=h.findFirst(A,"code",b[c.name]),p.forEach(A,function(a){b[c.name]===a.code?l.push({label:a.name,value:a.code,selected:!0}):
l.push({label:a.name,value:a.code});a.code===y&&(z=!0)}),h.isValueEmpty(b[c.name])&&c.nullable?l.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0}):h.isValueEmpty(b[c.name])&&!c.nullable?l.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0,disabled:!0}):c.nullable&&l.push({label:this._i18nStrings.empty,value:this._nullConstant}),z||y||null===b[c.name]||l.push({label:b[c.name].toString(),value:"N/A",selected:!0,disabled:!0}),q=new F({options:l,"class":this.css.select,
style:{width:"100%"}}),q.placeAt(e),q.focus(),this.emit("editor-show",{cell:d,editor:q,grid:this}),q.on("blur",f.hitch(this,function(){var a=h.findFirst(A,"code",b[c.name]);e.innerHTML=a?this._formatStringCellContent({fieldInfo:c,value:a.name}):this._formatStringCellContent({fieldInfo:c,value:b[c.name]})})),q.on("keydown",function(a){a.keyCode===B.ENTER&&q.focusNode.blur()}),q.on("change",f.hitch(this,function(a){r={fieldName:c.name,oldValue:b[c.name],rowId:b[g],row:b};a===this._nullConstant&&(a=
null);b[c.name]=a;a=h.findFirst(A,"code",a);e.innerHTML=a?this._formatStringCellContent({fieldInfo:c,value:a.name}):"";this.emit("editor-hide",{cell:d,editor:q,grid:this});q.destroy();this._applyEdits({row:b,rollbackInfo:r})})),this._activeEditors.push({id:b[g],widget:q})):(t=new E({value:b[c.name],required:!c.nullable}),t.placeAt(e),t.focus(),t.textbox.select(),this.emit("editor-show",{cell:d,editor:t,grid:this}),t.on("blur",f.hitch(this,function(){e.innerHTML=b[c.name]})),t.on("keydown",function(a){a.keyCode===
B.ENTER&&t.isValid()&&t.focusNode.blur()}),t.on("change",f.hitch(this,function(a){r={fieldName:c.name,oldValue:b[c.name],rowId:b[g],row:b};t.isValid()?(b[c.name]=a,e.innerHTML=a,this._applyEdits({row:b,rollbackInfo:r})):e.innerHTML=b[c.name]})),this._activeEditors.push({id:b[g],widget:t}),t.destroy())}}))},_setUpStringCell:function(a){var b=a.row,d=a.cellNode,c=a.fieldInfo,e=a.container,g=this.idProperty,m,k;v(d,this.editOn,f.hitch(this,function(){if(this.editable&&c.editable){var a=h.compareIntArrays(this.selectedRowIds,
this._previousSelectedRowIds);if(this.editOn!=x||a)k&&k.destroy(),this._closeCellEditors(),e.innerHTML="",k=new Y({value:b[c.name],required:!c.nullable,maxLength:c.length?c.length:null}),k.placeAt(e),k.focus(),k.textbox.select(),this.emit("editor-show",{cell:d,editor:k,grid:this}),k.on("blur",f.hitch(this,function(){e.innerHTML=this._formatStringCellContent({fieldInfo:c,value:b[c.name]});d.focus()})),k.on("keydown",function(a){a.keyCode===B.ENTER&&k.isValid()&&k.focusNode.blur()}),k.on("change",f.hitch(this,
function(a){m={fieldName:c.name,oldValue:b[c.name],rowId:b[g],row:b};""===a&&(a=null);k.isValid()?(b[c.name]=a,e.innerHTML=this._formatStringCellContent({fieldInfo:c,value:a}),this._applyEdits({row:b,rollbackInfo:m})):e.innerHTML=this._formatStringCellContent({fieldInfo:c,value:b[c.name]})})),this._activeEditors.push({id:b[g],widget:k})}}))},_formatStringCellContent:function(a){var b=a.value;return(a=(a=a.fieldInfo)?a.format:null)&&(a.embeddedHTML||!1===a.link)?h.isValueEmpty(b)?"":b:a&&a.template?
h.isValueEmpty(b)?"":z.substitute(a.template,{value:b}):h.generateLinkFromString(b)},_formatNumberCellContent:function(a){var b=a.value,d=(a=a.fieldInfo.format)?a.template:null;return null!==b?d?z.substitute(d,{value:h.formatNumberForLocale(b,a)}):h.formatNumberForLocale(b,a):null===b?"":h.formatNumberForLocale(b)},_generateAttachmentsCell:function(a){if(this.layerInfo){var b=a.row,d=a.cellValue,c=a.cellNode,e=a.fieldInfo;a=this.layerInfo;var g=this.css,m=this._i18nStrings,k,l;l=h.isValueEmpty(d)?
"":z.substitute(m.parenValue,{value:d});k=r.create("div",{innerHTML:l,className:g.attachmentsCell},c);r.create("span",{innerHTML:0<d||!a.queryAttachmentsSupported?" "+m.show:this.editable&&a.editable?" "+m.add:"",className:g.attachmentsLink},k);v(k,x,f.hitch(this,function(){this._showAttachmentsHandler({row:b,fieldInfo:e,cellValue:d,cellNode:c,textContainer:k})}))}},_generateRelatedRecordsCell:function(a){var b=a.row,d=a.cellValue,c=a.cellNode,e=a.fieldInfo;a=this.css;var g=this._i18nStrings,m;m=
h.isValueEmpty(d)?"":z.substitute(g.parenValue,{value:d})+" ";m=r.create("div",{innerHTML:m,className:a.relatedRecordsCell},c);r.create("span",{innerHTML:0<d?g.show:"",className:a.relatedRecordsLink},m);v(c,x,f.hitch(this,function(a){0<d&&(a=this.dGrid.cell(a).column,this._showRelatedRecordsHandler({row:b,fieldInfo:e,column:a,count:d}))}))},updateHeaderText:function(a){var b=a?a.count:null,d=a?a.selectedCount:null,c=a?a.title:null;a=a?a.showFilterCount:!0;c=h.isValueEmpty(c)?this._tableTitle||this.layer.name||
this._i18nStrings.untitled:c;b=h.isValueEmpty(b)?this.featureCount:b;d=h.isValueEmpty(d)?this.selectedFeatureCount:d;this.filterIds&&0<this.filterIds.length&&a&&(b=this.filterIds.length);this.showFeatureCount?this.setHeaderTitle(z.substitute(this._i18nStrings.gridHeader,{gridTitle:c,featureCount:b,featureSelectedCount:d})):this.setHeaderTitle(c)},_generateOptionsMenu:function(){var a=[],b,d,c;d=new J({className:this.css.optionsMenu});this.showDefaultSortMenuItem&&a.push({label:this._i18nStrings.defaultSort,
callback:this._sortFieldDefaultCallback});this.showFilterMenuItems?a.push({label:this._i18nStrings.showSelected,callback:this._showSelectedRecordsCallback},{label:this._i18nStrings.clearSelection,callback:this._clearFilterCallback}):a.push({label:this._i18nStrings.clearSelection,callback:this.clearSelection});this.gridOptions.columnHider&&a.push({label:this._i18nStrings.toggleColumns,callback:this.showColumnToggleMenu});this.map&&this.syncSelection&&a.push({label:this._i18nStrings.centerOnSelection,
callback:this.centerOnSelection});this.menuFunctions&&0<this.menuFunctions.length&&p.forEach(this.menuFunctions,function(b){a.push({label:b.label,callback:b.callback})},this);p.forEach(a,function(a){b=new y({label:a.label,baseClass:this.css.menuItem,onClick:f.hitch(this,a.callback)});d.addChild(b)},this);c=new W({label:this._i18nStrings.options,dropDown:d},this._gridMenuNode);this.set({optionsMenu:d,optionsMenuAnchor:c})},_sortFieldDefaultCallback:function(){var a=this.defaultSort.attribute,b=this.defaultSort.descending;
this.set("sort",{field:a,descending:b});this.emit("sort",{field:a,descending:b,orderByFields:[h.getOrderByString(a,b)]})},_showSelectedRecordsCallback:function(){0!==this.selectedRowIds.length&&this.emit("show-selected-records",{ids:this.selectedRowIds})},_clearFilterCallback:function(){this.emit("clear-selection");this.emit("clear-filter")},showColumnToggleMenu:function(){this.dGrid._toggleColumnHiderMenu()},_generateColumnMenu:function(a){var b=this.dGrid.cell(a),d=b?b.column:null;if(d){var c=this.columnMenu,
e=this.columnMenuFunctions,d=d.id,g=this.dGrid.columns[d],m=h.findFirst(this.fieldInfos,"name",g.field),k="esriRelatedRecords"===g.type||"esriAttachments"===g.type,l;c&&this.set("columnMenu",null);k||!1===g.sortable||(l=new J,this._generateSortMenuItems({menu:l,columnId:d}),this._generateStatisticsMenuItem({menu:l,fieldInfo:m,columnId:d}),this._generateFieldDetailsMenuItem({menu:l,fieldInfo:m,column:g}),e&&0<e.length&&p.forEach(e,function(a){l.addChild(new y({label:a.label,iconClass:a.iconClass||
"",baseClass:a.baseClass||"",onClick:f.hitch(this,a.callback,m)}))}),l.startup(),this._showColumnMenu({menu:l,cell:b,evt:a,fieldInfo:m,previousMenu:c}),this.set("columnMenu",l))}},_showColumnMenu:function(a){var b=a.menu,d=a.cell,c=a.evt,e=a.previousMenu,g;g=d.element.getBoundingClientRect();a=g.top+g.height;g=this.isLeftToRight()?g.right-g.width:g.right;b._openMyself({target:c.target,delegatedTarget:d,iframe:null,coords:{x:g,y:a}});v(b,"close",function(){e&&(e.destroyRecursive(),e=null)})},_generateSortMenuItems:function(a){var b=
a.menu;a=a.columnId;var d=this.css;b.addChild(new y({label:this._i18nStrings.sortAsc,iconClass:d.sortAscendingIcon,baseClass:d.menuItem,onClick:f.hitch(this,this._sortFieldAscendingHandler,a)}));b.addChild(new y({label:this._i18nStrings.sortDesc,iconClass:d.sortDescendingIcon,baseClass:d.menuItem,onClick:f.hitch(this,this._sortFieldDescendingHandler,a)}))},_sortFieldAscendingHandler:function(a){var b=this.dGrid.columns[a];this.emit("sort",{column:b,id:a,field:b.field,descending:!1,orderByFields:[h.getOrderByString(b.field,
!1)]})},_sortFieldDescendingHandler:function(a){var b=this.dGrid.columns[a];this.emit("sort",{column:b,id:a,field:b.field,descending:!0,orderByFields:[h.getOrderByString(b.field,!0)]})},_generateStatisticsMenuItem:function(a){var b=a.menu,d=a.fieldInfo,c=this.css,e=this.layer,g=!!this.layerInfo.isFeatureCollection,e=e.advancedQueryCapabilities.supportsStatistics||e.supportsStatistics;!this.showStatistics||!e||!d||d.domain&&d.domain.codedValues||d.subtypeDomain||d.typeId||g||h.isNumericFieldType(d.type)&&
b.addChild(new y({label:this._i18nStrings.statistics,iconClass:c.statisticsIcon,baseClass:c.menuItem,onClick:f.hitch(this,this._showStatisticsHandler,a)}))},_generateFieldDetailsMenuItem:function(a){if(this.showFieldDetails){var b=a.menu,d=a.fieldInfo,c=parseInt(a.column.id,10);a=this.css;"esriFieldTypeOID"!==d.type&&"esriFieldTypeGlobalID"!==d.type&&-1===p.indexOf(this._unsupportedFieldTypes,d.type)&&b.addChild(new y({label:this._i18nStrings.showDetailedView,iconClass:a.propertiesIcon,baseClass:a.menuItem,
onClick:f.hitch(this,function(){this.emit("show-detailed-field-view",{columnId:c,fieldInfo:d})})}))}},_generateColumnHiderButton:function(){var a=this.css,a=r.create("div",{className:a.menuItem+" "+a.button+" "+a.menuIcon,tabIndex:0});r.place(a,this._gridTitleNode,"before");v(a,x,f.hitch(this,this.showColumnHiderMenu));this._columnHiderButton=a},_fetchAttachments:function(a){return h.queryLayerForAttachments({layer:this.layer,ids:a||null})},_showAttachmentsHandler:function(a){var b=a.row,d=a.fieldInfo,
c=a.cellValue,e=a.cellNode;a=this.layerInfo;var g=b[this.idProperty],h,k;if(0!==c||a.editCapabilities.canCreate)a=G.generateAttachmentsDialog({layer:this.layer,featureId:g,attachments:this.attachmentInfos[g]?this.attachmentInfos[g].attachments:[],editable:this.editable&&a.editable,css:this.css}),k=a.featureAttachments,h=k.attachments,this.own(k.on("add-complete",f.hitch(this,function(a){this.attachmentInfos[g]||(this.attachmentInfos[g]={});this.attachmentInfos[g].attachments=a.attachments;c+=1;e.innerHTML=
"";this._generateAttachmentsCell({row:b,fieldInfo:d,cellValue:c,cellNode:e})})),k.on("delete-complete",f.hitch(this,function(a){this.attachmentInfos[g].attachments=a.attachments;--c;e.innerHTML="";this._generateAttachmentsCell({row:b,fieldInfo:d,cellValue:c,cellNode:e})}))),this.emit("show-attachments",{featureId:g,attachments:h,dialog:a.dialog})},_updateAttachmentInfos:function(a){return f.mixin(this.attachmentInfos,a)},_fetchRelatedRecords:function(a){return h.queryLayerForRelatedRecords({layer:this.layer,
ids:a.ids||null,relationship:a.relationship,outFields:a.outFields||["*"]})},_showRelatedRecordsHandler:function(a){var b=a.row,d=this.idProperty,c=b[d],e=a.fieldInfo.relationship;a=a.count;var g=this.columns,f=this.layer,k=f.getField(e.keyField),l=(k=k?k.name:null)?b[k]:null,n,q;n=p.filter(g,function(a){return!a.hidden});d=[h.findFirst(n,"field",f.displayField),h.findFirst(n,"field",k),h.findFirst(n,"type","esriFieldTypeString"),h.findFirstNumberColumn(g,d),h.findFirst(n,"type","esriFieldTypeDate")];
p.some(d,function(a){if(this._validateRelatedColumnDisplay(a))return q=p.indexOf(g,a),!0},this);h.isValueEmpty(q)&&(q=0);this.emit("show-related-records",{row:b,featureId:c,keyField:k,keyFieldValue:l,columnId:q,relationship:e,count:a})},_setUpRelatedRecordInfos:function(a){var b=a.records,d=this.relatedRecordInfos;p.forEach(a.relationships,function(a,e){d[a.id]=b[e]});return d},_updateRelatedRecordInfos:function(a){this.relatedRecordInfos=h.mergeDictionaries(this.relatedRecordInfos,a)},_updateRelatedRecordCounts:function(a){var b=
this.relatedRecordCounts,d={};p.forEach(this.layer.relationships,function(b){var c=a[b.id].relatedRecordGroups;d[b.id]={};p.forEach(c,function(a){d[b.id][a.objectId]={count:a.count}})});this.relatedRecordCounts=h.mergeDictionaries(b,d)},_getRelatedRecordsById:function(a){var b=a.featureId;a=a.relationshipId;return this.relatedRecordInfos[a]?this.relatedRecordInfos[a][b]:[]},_getRelatedRecordsCount:function(a){var b=a.featureId;a=a.relationshipId;return this.layerInfo.supportsAdvancedQueryRelated?
(b=this.relatedRecordCounts[a]?this.relatedRecordCounts[a][b]:{})?b.count:0:(b=this._getRelatedRecordsById({featureId:b,relationshipId:a}))&&b.features?b.features.length:0},_generateRelatedRecordFieldInfos:function(a){var b=a.fieldInfos,d=this.visibleLayerIds,c=!1,e,g;p.some(a.relationships,function(a,f){f===this._relationshipColumnLimit&&(c=!0);g=h.isCyclicalRelationship(a);(e=d?d[d.length-1]===a.relatedTableId:!1)&&g&&!this.showCyclicalRelationships||b.push({alias:a.name,name:a.name,type:"esriRelatedRecords",
hidden:c,relatedIndex:f,relationship:a})},this)},_validateRelatedColumnDisplay:function(a){return!(!a||a.hidden||-1===p.indexOf(this.columns,a)||"esriFieldTypeOID"===a.type||"esriFieldTypeGlobalID"===a.type)},_showStatisticsHandler:function(a){var b=a.columnId,d=a.fieldInfo,c;a=this.where||this.layer.getDefinitionExpression?this.layer.getDefinitionExpression():"1\x3d1";h.getFieldStatistics({grid:this.dGrid,layer:this.layer,fieldInfo:d,idProperty:this.idProperty,filterIds:this.filterIds,where:a,columnId:b}).then(f.hitch(this,
function(a){c=G.generateStatisticsDialog({data:a,fieldName:d.name,css:this.css});this.emit("show-statistics",c)}))},_addGridListeners:function(){this._setUpRowSelectListener();this._setUpRowDeselectListener();this._setUpDataChangeListener();this._setUpRefreshListener();this._setUpColumnClickListener();this._setUpColumnStateChangeListener();this._setUpColumnResizeListener();this._setUpErrorListener();this._setUpSortListener();this._setUpFilterListener();this._setUpEditorShowListener();this._setUpEditorHideListener();
this.own(this._setUpStoreLoadListener(),this._setUpLayerClickListener(),this._setUpLayerSelectionCompleteListener(),this._setUpLayerSelectionClearListener(),this._setUpLayerUpdateEndListener())},_setUpStoreLoadListener:function(){var a=this.watch("store",f.hitch(this,function(b,d,c){null===d&&c&&(this.set("loaded",!0),this.emit("load",{loaded:!0}),a.remove())}));return a},_setUpRowSelectListener:function(){return this.dGrid.on("dgrid-select",f.hitch(this,function(a){this._updateSelection().then(f.hitch(this,
function(){this.updateHeaderText();this.emit("row-select",a)}))}))},_setUpRowDeselectListener:function(){return this.dGrid.on("dgrid-deselect",f.hitch(this,function(a){this._previousSelectedRowIds=this.selectedRowIds;this._updateSelection().then(f.hitch(this,function(){this.updateHeaderText();this.emit("row-deselect",a)}))}))},_setUpDataChangeListener:function(){return this.dGrid.on("dgrid-datachange",f.hitch(this,function(a){var b=a.cell.column.field,d=h.findFirst(this.fieldInfos,"name",b),c=a.cell.row.data,
e=c[this.idProperty],g=a.value;a=a.oldValue;var m=h.isIntegerFieldType(d.type),d=h.isFloatFieldType(d.type),k={oldValue:a,fieldName:b,rowId:e,row:c};""===g&&(g=null);m&&null!==g&&(g=parseInt(g,10));d&&null!==g&&(g=parseFloat(g));g&&g.getTime&&g.getTime()?c[b]=g.getTime():c[b]=g;this.showLoadingIndicator();this._updateSelection().then(f.hitch(this,function(){this.updateHeaderText();this._applyEdits({row:c,rollbackInfo:k})}));this.emit("data-change",{row:c,rollbackInfo:k})}))},_setUpRefreshListener:function(){return this.dGrid.on("dgrid-refresh-complete",
f.hitch(this,function(a){this.dGrid.columns[0]&&this.emit("refresh",a)}))},_setUpColumnClickListener:function(){return this.dGrid.on(".dgrid-header .dgrid-cell:click",f.hitch(this,this._generateColumnMenu))},_setUpColumnStateChangeListener:function(){return this.dGrid.on("dgrid-columnstatechange",f.hitch(this,function(a){this.emit("column-state-change",a)}))},_setUpColumnResizeListener:function(){return this.dGrid.on("dgrid-columnresize",f.hitch(this,function(a){this.emit("column-resize",a)}))},_setUpErrorListener:function(){return this.dGrid.on("dgrid-error",
f.hitch(this,function(a){this.emit("error",a)}))},_setUpSortListener:function(){return this.dGrid.on("dgrid-sort",f.hitch(this,function(a){this.emit("sort",a)}))},_setUpFilterListener:function(){return this.dGrid.on("dgrid-filter",f.hitch(this,function(a){this.emit("filter",a)}))},_setUpEditorShowListener:function(){return this.dGrid.on("dgrid-editor-show",f.hitch(this,function(a){this.emit("editor-show",a)}))},_setUpEditorHideListener:function(){return this.dGrid.on("dgrid-editor-hide",f.hitch(this,
function(a){this.emit("editor-hide",a)}))},_setUpLayerClickListener:function(){return v(this.layer,"click",f.hitch(this,function(a){this.emit("layer-click",a)}))},_setUpLayerSelectionCompleteListener:function(){return v(this.layer,"selection-complete",f.hitch(this,function(a){this.emit("layer-selection-complete",a)}))},_setUpLayerSelectionClearListener:function(){return v(this.layer,"selection-clear",f.hitch(this,function(a){this.emit("layer-selection-clear",a)}))},_setUpLayerUpdateEndListener:function(){return v(this.layer,
"update-end",f.hitch(this,function(a){this.emit("layer-update-end",a)}))}});Q("extend-esri")&&f.setObject("dijit.Grid",D,P);return D});