// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.20/esri/copyright.txt for details.
//>>built
define("esri/arcgis/utils","require dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/Deferred dojo/_base/json dojo/_base/url dojo/on dojo/DeferredList dojo/dom-construct dojo/sniff ../kernel ../config ../Color ../lang ../request ../SpatialReference ../map ../urlUtils ../geometry/ScreenPoint ../geometry/Extent ../geometry/webMercatorUtils ../symbols/jsonUtils ../renderers/jsonUtils ../dijit/PopupTemplate ../dijit/Popup ../tasks/query ../tasks/GeometryService ../layers/ArcGISTiledMapServiceLayer ../layers/FeatureLayer dojo/i18n!../nls/jsapi".split(" "),
function(J,n,k,u,q,K,Za,U,D,$a,pb,H,L,ab,l,A,C,bb,V,ja,E,cb,F,I,ka,db,eb,fb,gb,w,W){function G(a){return A({url:t.arcgisUrl+"/"+a.itemId+"/data",content:{f:"json"},callbackParamName:"callback"},{disableIdentityLookup:!0,_preLookup:!0})}function X(a,f){var e={f:"json"};f&&(e.token=f);return A({url:a,content:e,callbackParamName:"callback"},{disableIdentityLookup:!0})}function Y(a){!a.layerDefinition||a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.labelingInfo||(a.showLabels=!1);a.itemProperties.layerDefinition&&
(a.layerDefinition?(a.layerDefinition.drawingInfo||(a.layerDefinition.drawingInfo=a.itemProperties.layerDefinition.drawingInfo),l.isDefined(a.layerDefinition.definitionExpression)||(a.layerDefinition.definitionExpression=a.itemProperties.layerDefinition.definitionExpression),l.isDefined(a.layerDefinition.minScale)||(a.layerDefinition.minScale=a.itemProperties.layerDefinition.minScale),l.isDefined(a.layerDefinition.maxScale)||(a.layerDefinition.maxScale=a.itemProperties.layerDefinition.maxScale)):
a.layerDefinition=a.itemProperties.layerDefinition);!a.itemProperties.popupInfo||a.popupInfo||a.disablePopup||(a.popupInfo=a.itemProperties.popupInfo);l.isDefined(a.itemProperties.showLabels)&&!l.isDefined(a.showLabels)&&(a.showLabels=a.itemProperties.showLabels);l.isDefined(a.itemProperties.showLegend)&&!l.isDefined(a.showLegend)&&(a.showLegend=a.itemProperties.showLegend);l.isDefined(a.itemProperties.refreshInterval)&&!l.isDefined(a.refreshInterval)&&(a.refreshInterval=a.itemProperties.refreshInterval)}
function la(a){Y(a);a.itemProperties.layerDefinition&&a.layerDefinition&&(!l.isDefined(a.layerDefinition.maximumTrackPoints)&&l.isDefined(a.itemProperties.layerDefinition.maximumTrackPoints)&&(a.layerDefinition.maximumTrackPoints=a.itemProperties.layerDefinition.maximumTrackPoints),!a.layerDefinition.definitionGeometry&&a.itemProperties.layerDefinition.definitionGeometry&&(a.layerDefinition.definitionGeometry=a.itemProperties.layerDefinition.definitionGeometry));a.itemProperties.purgeOptions&&!a.purgeOptions&&
(a.purgeOptions=a.itemProperties.purgeOptions)}function M(a,f){var e=new q,c=a.itemData,b=[],g=[];k.forEach(c.operationalLayers,function(a){if(a.itemId&&!a.type){var d=a.url.toLowerCase();-1<d.indexOf("/featureserver")||-1<d.indexOf("/mapserver/")?(g.push(a),b.push(G(a))):-1<d.indexOf("/mapserver")&&-1===d.indexOf("/mapserver/")&&(!a.layers||!l.isDefined(a.minScale)&&!l.isDefined(a.maxScale))?(g.push(a),b.push(G(a))):-1<d.indexOf("/imageserver")&&!l.isDefined(a.minScale)&&!l.isDefined(a.maxScale)?
(g.push(a),b.push(G(a))):-1<d.indexOf("/streamserver")&&(g.push(a),b.push(G(a)))}});c.baseMap&&c.baseMap.baseMapLayers&&k.forEach(c.baseMap.baseMapLayers,function(a){a.itemId&&"VectorTileLayer"!==a.layerType&&(g.push(a),b.push(G(a)))});if(0<b.length){var d={};(new D(b)).addCallback(function(c){k.forEach(g,function(a,e){var b=c[e][1];if(b&&!(b instanceof Error)&&(d[a.itemId]=b,!a.type)){var g=a.url.toLowerCase();(-1<g.indexOf("/featureserver")||-1<g.indexOf("/mapserver/"))&&b.layers?k.forEach(b.layers,
function(b){var d="/featureserver/"+b.id;(d=g.match(d+"$")==d)||(d="/mapserver/"+b.id,d=g.match(d+"$")==d);d&&(a.itemProperties=b,Y(a))}):-1<g.indexOf("/streamserver")?(a.itemProperties=b,la(a)):-1<g.indexOf("/mapserver")?(b.layers&&!a.layers&&(a.layers=b.layers),l.isDefined(b.minScale)&&!l.isDefined(a.minScale)&&(a.minScale=b.minScale),l.isDefined(b.maxScale)&&!l.isDefined(a.maxScale)&&(a.maxScale=b.maxScale),l.isDefined(b.refreshInterval)&&!l.isDefined(a.refreshInterval)&&(a.refreshInterval=b.refreshInterval),
b.visibleLayers&&!a.visibleLayers&&(a.visibleLayers=b.visibleLayers)):-1<g.indexOf("/imageserver")&&(l.isDefined(b.minScale)&&!l.isDefined(a.minScale)&&(a.minScale=b.minScale),l.isDefined(b.maxScale)&&!l.isDefined(a.maxScale)&&(a.maxScale=b.maxScale),l.isDefined(b.refreshInterval)&&!l.isDefined(a.refreshInterval)&&(a.refreshInterval=b.refreshInterval),!b.popupInfo||a.popupInfo||a.disablePopup||(a.popupInfo=b.popupInfo),b.renderingRule&&!a.renderingRule&&(a.renderingRule=b.renderingRule,b.renderingRule.functionName&&
(a.renderingRule.rasterFunction=b.renderingRule.functionName)),b.bandIds&&!a.bandIds&&(a.bandIds=b.bandIds),b.mosaicRule&&!a.mosaicRule&&(a.mosaicRule=b.mosaicRule),b.format&&!a.format&&(a.format=b.format),l.isDefined(b.compressionQuality)&&!l.isDefined(a.compressionQuality)&&(a.compressionQuality=b.compressionQuality),!b.layerDefinition||!b.layerDefinition.definitionExpression||l.isDefined(a.layerDefinition)&&l.isDefined(a.layerDefinition.definitionExpression)||(a.layerDefinition=a.layerDefinition||
{},a.layerDefinition.definitionExpression=b.layerDefinition.definitionExpression))}});a.relatedItemsData=d;e.callback(a)})}else e.callback(a);return e}function hb(a,f){var e=new q,c=a.itemData,b=c.baseMap.baseMapLayers[0];if("BingMapsAerial"===b.type||"BingMapsRoad"===b.type||"BingMapsHybrid"===b.type)if(b.portalUrl&&H.id)delete f.bingMapsKey,H.id.checkSignInStatus(V.urlToObject(t.arcgisUrl).path).then(n.hitch(null,function(a,c,e,g,f){X(b.portalUrl,f.token).then(n.hitch(null,Z,a,c,e,g),n.hitch(null,
N,a,c,e,g))},a,f,c,e),n.hitch(null,function(a,c,e,g,f){X(b.portalUrl).then(n.hitch(null,Z,a,c,e,g),n.hitch(null,N,a,c,e,g))},a,f,c,e));else if(f.bingMapsKey){var g=new y({bingMapsKey:f.bingMapsKey,mapStyle:y.MAP_STYLE_AERIAL});u.connect(g,"onLoad",n.hitch(this,function(){e.callback([a,f])}));u.connect(g,"onError",function(d){delete f.bingMapsKey;a.itemData=O(c);b=a.itemData.baseMap.baseMapLayers[0];b.errors=[];b.errors.push({message:"The owner of the application has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});
e.callback([a,f])})}else a.itemData=O(c),b=a.itemData.baseMap.baseMapLayers[0],b.errors=[],b.errors.push({message:"The owner of the application has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."}),e.callback([a,f]);else e.callback([a,f]);return e}function ib(a){var f=new q,e,c;a=a.itemData;var b=a.baseMap&&a.baseMap.baseMapLayers;if(P&&!P.supported())for(a=0;a<b.length;a++){var g=b[a];if(!g.isReference){"VectorTileLayer"===g.layerType&&(e=g.itemId,c=a);break}}e?aa(e,
!1).addBoth(function(a){var d=/^https?:\/\/basemaps(dev)?\.arcgis\.com\/arcgis\/rest\/services\/World_Basemap\/VectorTileServer/i;a&&a.item&&d.test(a.item.url)&&(b[c]={id:"FB_"+g.id,layerType:"ArcGISTiledMapServiceLayer",opacity:"opacity"in g?g.opacity:1,visibility:"visibility"in g?g.visibility:!0,url:"http://services.arcgisonline.com/arcgis/rest/services/World_Street_Map/MapServer"});f.resolve()}):f.resolve();return f}function Z(a,f,e,c,b){b.bingKey?(f.bingMapsKey=b.bingKey,b=new y({bingMapsKey:f.bingMapsKey,
mapStyle:y.MAP_STYLE_AERIAL}),u.connect(b,"onLoad",n.hitch(this,function(){c.callback([a,f])})),u.connect(b,"onError",function(b){delete f.bingMapsKey;a.itemData=O(e);b=a.itemData.baseMap.baseMapLayers[0];b.errors=[];b.errors.push({message:"The owner of the map has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});c.callback([a,f])})):N(a,f,e,c)}function N(a,f,e,c){delete f.bingMapsKey;a.itemData=O(e);e=a.itemData.baseMap.baseMapLayers[0];e.errors=[];e.errors.push({message:"The owner of the map has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."});
c.callback([a,f])}function O(a){a.baseMap="BingMapsAerial"===a.baseMap.baseMapLayers[0].type?{title:"Imagery",baseMapLayers:[{id:"World_Imagery_2017",visibility:!0,opacity:1,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}]}:"BingMapsRoad"===a.baseMap.baseMapLayers[0].type?{title:"Streets",baseMapLayers:[{id:"World_Street_Map_8421",opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"}]}:{title:"Imagery with Labels",
baseMapLayers:[{id:"World_Imagery_6611",opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"},{id:"World_Boundaries_and_Places_1145",isReference:!0,opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer"}]};return a}function ba(a,f,e,c){var b=a.dynamicLayerInfos||a.layerInfos,g=f.layers;if(g&&b)if(c.usePopupManager){var d;k.forEach(b,function(a){var b=a.id;if(!a.subLayerIds)for(a=
0;a<g.length;a++){var c=g[a];if(c.id===b&&c.popupInfo){d||(d={});d[b]={infoTemplate:new e(c.popupInfo),layerUrl:c.layerUrl};break}}});d&&a.setInfoTemplates(d)}else{var h=[],m=[],x=[],p=[],r=[],v=[];k.forEach(b,function(b){var c=b.id;if(!b.subLayerIds&&-1!==k.indexOf(a.visibleLayers,c))for(b=0;b<g.length;b++){var d=g[b];if(d.id===c){m.push(c);h.push(d.popupInfo);x.push(d.layerUrl||"");d.layerDefinition&&d.layerDefinition.definitionExpression?p.push(d.layerDefinition.definitionExpression):p.push("");
r.push(l.isDefined(d.minScale)?d.minScale:null);v.push(l.isDefined(d.maxScale)?d.maxScale:null);break}}});h.length&&(a.__popups=h,a.__popupIds=m,a.__popupUrls=x,a.__popupWhereClauses=p,a.__popupMinScales=r,a.__popupMaxScales=v,a.__resourceInfo=f.resourceInfo)}}function ma(a){if(!a)return!1;var f=(new Za(t.arcgisUrl)).authority;return-1!==a.indexOf(".arcgis.com/")||-1!==a.indexOf(f)}function na(a){return a?-1!==a.indexOf("/services.arcgisonline.com/")||-1!==a.indexOf("/server.arcgisonline.com/"):!1}
function B(a){"https:"===location.protocol&&(ma(a)||na(a))&&(a=a.replace("http:","https:"));return a}function ca(a,f,e){var c=[],b;a.displayLevels||(c=k.map(a.resourceInfo.tileInfo.lods,function(a){return a.level}));a.exclusionAreas&&(b=n.clone(a.exclusionAreas),b=k.map(b,function(a){a.geometry=new E(a.geometry);return a}));c=new gb(B(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,displayLevels:a.displayLevels||c,id:a.id,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval,
exclusionAreas:b});e.ignorePopups||ba(c,a,f,e);return c}function da(a,f){if(!a||!f||0===f.length)return[];var e=","+f+",",c=[],b,g=",";for(b=0;b<a.length;b++)if(null!==a[b].subLayerIds){if(-1===e.indexOf(","+a[b].id+",")||-1<g.indexOf(","+a[b].id+","))g+=a[b].subLayerIds.toString()+","}else-1<e.indexOf(","+a[b].id+",")&&-1===g.indexOf(","+a[b].id+",")&&c.push(a[b].id);return c}function oa(a,f,e){var c=new pa;c.format="png24";a.resourceInfo&&a.resourceInfo.supportedImageFormatTypes&&-1<a.resourceInfo.supportedImageFormatTypes.indexOf("PNG32")&&
(c.format="png32");var c=new qa(B(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageParameters:c,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval}),b=a.visibleLayers;if(!a.visibleLayers){var g="";k.forEach(c.layerInfos,function(a){a.defaultVisibility&&(g+=(0<g.length?",":"")+a.id)});b=g}if(a.layers&&0<a.layers.length){var d=[],h=[],m,x=[],p,r;k.forEach(a.layers,function(b){b.layerDefinition&&b.layerDefinition.definitionExpression&&(d[b.id]=
b.layerDefinition.definitionExpression);if(b.layerDefinition&&b.layerDefinition.source){m=null;r=b.layerDefinition.source;if("mapLayer"===r.type){var c=k.filter(a.resourceInfo.layers,function(a){return a.id===r.mapLayerId});c.length&&(m=n.mixin(c[0],b))}else m=n.mixin({},b);m&&(m.source=r,delete m.popupInfo,m=new ra(m),a.visibleLayers&&(c="string"==typeof a.visibleLayers?a.visibleLayers.split(","):a.visibleLayers,-1<k.indexOf(c,b.id)?m.defaultVisibility=!0:m.defaultVisibility=!1),h.push(m))}b.layerDefinition&&
b.layerDefinition.source&&b.layerDefinition.drawingInfo&&(p=new sa(b.layerDefinition.drawingInfo),x[b.id]=p)},this);0<d.length&&c.setLayerDefinitions(d);0<h.length?(c.setDynamicLayerInfos(h,!0),0<x.length&&c.setLayerDrawingOptions(x,!0)):(b=da(c.layerInfos,b),c.setVisibleLayers(b))}else b=da(c.layerInfos,b),c.setVisibleLayers(b);e.ignorePopups||ba(c,a,f,e);return c}function jb(a,f,e){var c=new ta;c.bandIds=a.bandIds;null!=a.format&&(c.format=a.format,null!=a.compressionQuality&&(c.compressionQuality=
a.compressionQuality));if(a.renderingRule&&a.renderingRule.rasterFunction){var b=new ua(a.renderingRule);c.renderingRule=b}a.mosaicRule&&(b=new va(a.mosaicRule),c.mosaicRule=b);l.isDefined(a.noData)&&(c.noData=a.noData);l.isDefined(a.noDataInterpretation)&&(c.noDataInterpretation=a.noDataInterpretation);l.isDefined(a.interpolation)&&(c.interpolation=a.interpolation);b=a.layerType?"ArcGISImageServiceVectorLayer"===a.layerType:!1;l.isDefined(a.layerType)||(b=a.resourceInfo.hasMultidimensions&&("esriImageServiceDataTypeVector-UV"===
a.resourceInfo.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===a.resourceInfo.serviceDataType));c={resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageServiceParameters:c,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval};c=b?new wa(B(a.url),c):new xa(B(a.url),c);a.layerDefinition&&(a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&(b=I.fromJson(a.layerDefinition.drawingInfo.renderer),c.setRenderer(b)),a.layerDefinition.definitionExpression&&
c.setDefinitionExpression(a.layerDefinition.definitionExpression,!0));!e.ignorePopups&&a.popupInfo&&c.setInfoTemplate(new f(a.popupInfo));return c}function ea(a,f,e){var c=[102113,102100,3857],b=e||new C(f[0].layerObject.fullExtent.spatialReference),g=new C(a.resourceInfo.fullExtent.spatialReference);return b.wkt==g.wkt&&(b.wkid==g.wkid||l.isDefined(b.latestWkid)&&b.latestWkid==g.wkid||l.isDefined(g.latestWkid)&&b.wkid==g.latestWkid||l.isDefined(b.latestWkid)&&b.latestWkid==g.latestWkid)||b.wkid&&
g.wkid&&k.some(c,function(a){return a===g.wkid})&&k.some(c,function(a){return a===b.wkid})?!0:!1}function fa(a,f,e){if(!f[0].layerObject.tileInfo)return!1;a=a.resourceInfo.tileInfo;f=f[0].layerObject.tileInfo;e=e.width>e.height?e.width:e.height;for(var c=!1,b=!1,g=0;g<a.lods.length;g++){for(var d=a.lods[g].scale/a.dpi,h=0;h<f.lods.length;h++){var m=f.lods[h].scale/f.dpi;if(Math.abs(m-d)/m<1/e)if(c){b=!0;break}else c=!0}if(b)break}return b||c&&(1===a.lods.length||1===f.lods.length)?!0:!1}function ya(a,
f,e,c,b,g){var d,h,m=e._clazz;if("OpenStreetMap"===a.type)d=new za({id:a.id,opacity:a.opacity,visible:null!==a.visibility&&void 0!==a.visibility?a.visibility:!0});else if("WFS"===a.type)c={customParameters:a.wfsInfo.customParameters,geometryType:a.layerDefinition.geometryType,id:a.id,labelingInfo:a.layerDefinition.drawingInfo.labelingInfo,maxFeatures:a.wfsInfo.maxFeatures,mode:a.mode,name:a.wfsInfo.name,showLabels:!0,swapXY:a.wfsInfo.swapXY,title:a.title,url:a.url,version:a.wfsInfo.version,visible:a.visibility,
wkid:a.layerDefinition.spatialReference.wkid},d=new Aa,d.fromJson(c,function(){l.isDefined(a.opacity)&&d.setOpacity(a.opacity);l.isDefined(a.visibility)&&d.setVisibility(a.visibility);(a.minScale||a.maxScale)&&d.setScaleRange(a.minScale,a.maxScale);d.renderer=I.fromJson(a.layerDefinition.drawingInfo.renderer);!e.ignorePopups&&a.popupInfo&&d.setInfoTemplate(new m(a.popupInfo));d.emit("fromJsonComplete")});else if("WMS"===a.type){var x=[],p=[];k.forEach(a.layers,function(a){p.push(new Ba({name:a.name,
title:a.title,legendURL:a.legendURL,queryable:a.queryable,showPopup:a.showPopup}));x.push(a.name)},this);a.visibleLayers&&(x=a.visibleLayers);c=new E(a.extent[0][0],a.extent[0][1],a.extent[1][0],a.extent[1][1],new C({wkid:4326}));c={customLayerParameters:a.customLayerParameters,customParameters:a.customParameters,extent:c,layerInfos:p,version:a.version,maxWidth:a.maxWidth,maxHeight:a.maxHeight,featureInfoFormat:a.featureInfoFormat,getFeatureInfoURL:a.featureInfoUrl,getMapURL:a.mapUrl,spatialReferences:a.spatialReferences,
title:a.title,copyright:a.copyright,minScale:a.minScale||0,maxScale:a.maxScale||0,format:a.format};d=new Ca(a.url,{id:a.id,visibleLayers:x,format:"png",transparent:a.firstLayer?!1:!0,opacity:a.opacity,visible:null!==a.visibility?a.visibility:!0,resourceInfo:c,refreshInterval:a.refreshInterval});d.spatialReference.wkid=c.spatialReferences[0]}else if("KML"===a.type){h=a.url;if(H.id){var r=H.id.findCredential(V.urlToObject(t.arcgisUrl).path);r&&(f=t.arcgisUrl.substring(t.arcgisUrl.indexOf("//")+2,t.arcgisUrl.indexOf("/",
t.arcgisUrl.indexOf("//")+3)),b=f.split("."),b=b[b.length-2]+"."+b[b.length-1],g=h.indexOf(b),-1<g&&(h="https://"+f+h.substring(g+b.length),h+="?token\x3d"+r.token))}d=new Da(h,{id:a.id,visible:null!==a.visibility?a.visibility:!0,outSR:c,refreshInterval:a.refreshInterval});u.connect(d,"onLoad",function(){(a.opacity||0===a.opacity)&&d.setOpacity(a.opacity);l.isDefined(a.minScale)&&l.isDefined(a.maxScale)&&d.setScaleRange(a.minScale,a.maxScale);a.visibleFolders&&k.forEach(d.folders,function(b){-1<k.indexOf(a.visibleFolders,
b.id)?d.setFolderVisibility(b,!0):d.setFolderVisibility(b,!1)},this)})}else if("WebTiledLayer"===a.type){if(d=new Ea(a.templateUrl,{id:a.id,visible:null!==a.visibility?a.visibility:!0,opacity:a.opacity,copyright:a.copyright,fullExtent:a.fullExtent&&new E(a.fullExtent),initialExtent:a.fullExtent&&new E(a.fullExtent),subDomains:a.subDomains,tileInfo:a.tileInfo?new Fa(a.tileInfo):null,refreshInterval:a.refreshInterval,wmtsInfo:a.wmtsInfo}),l.isDefined(a.minScale)||l.isDefined(a.maxScale))d.loaded?d.setScaleRange(a.minScale,
a.maxScale):u.connect(d,"onLoad",function(){d.setScaleRange(a.minScale,a.maxScale)})}else"GeoRSS"===a.type?(d=new Ga(a.url,{id:a.id,opacity:a.opacity,outSpatialReference:c,refreshInterval:a.refreshInterval}),u.connect(d,"onLoad",function(){!1===a.visibility&&d.hide();l.isDefined(a.minScale)&&l.isDefined(a.maxScale)&&d.setScaleRange(a.minScale,a.maxScale);var b=d.getFeatureLayers();k.forEach(b,function(c){a.pointSymbol&&"esriGeometryPoint"===c.geometryType?(c.renderer.symbol=F.fromJson(a.pointSymbol),
1===b.length&&(d.pointSymbol=F.fromJson(a.pointSymbol))):a.lineSymbol&&"esriGeometryPolyline"===c.geometryType?(c.renderer.symbol=F.fromJson(a.lineSymbol),1===b.length&&(d.polylineSymbol=F.fromJson(a.lineSymbol))):a.polygonSymbol&&"esriGeometryPolygon"===c.geometryType&&(c.renderer.symbol=F.fromJson(a.polygonSymbol),1===b.length&&(d.polygonSymbol=F.fromJson(a.polygonSymbol)))})})):"CSV"==a.type&&a.url?(c={layerDefinition:a.layerDefinition,columnDelimiter:a.columnDelimiter,id:a.id?a.id:null,visible:null!==
a.visibility?a.visibility:!0,opacity:a.opacity,refreshInterval:a.refreshInterval},a.locationInfo&&(c.latitudeFieldName=a.locationInfo.latitudeFieldName,c.longitudeFieldName=a.locationInfo.longitudeFieldName),e.ignorePopups||(c.infoTemplate=new ka(a.popupInfo?a.popupInfo:Ha.generateDefaultPopupInfo(a))),d=new Ia(a.url,c)):"VectorTileLayer"===a.layerType&&a.styleUrl?d=new P(a.styleUrl,{id:a.id,minScale:a.minScale,maxScale:a.maxScale,opacity:a.opacity,visible:a.visibility}):a.layerDefinition&&!a.url?
(c=K.fromJson(K.toJson(a)),delete c.id,delete c.opacity,delete c.visibility,d=new w(c,{id:a.id,opacity:a.opacity,visible:a.visibility,outFields:["*"],autoGeneralize:!0}),!e.ignorePopups&&c.popupInfo&&d.setInfoTemplate(new m(c.popupInfo)),Ja(d)):"BingMapsAerial"===a.type||"BingMapsRoad"===a.type||"BingMapsHybrid"===a.type?e.bingMapsKey?(c=y.MAP_STYLE_AERIAL_WITH_LABELS,"BingMapsAerial"===a.type?c=y.MAP_STYLE_AERIAL:"BingMapsRoad"===a.type&&(c=y.MAP_STYLE_ROAD),d=new y({bingMapsKey:e.bingMapsKey,mapStyle:c,
opacity:a.opacity,id:a.id}),u.connect(d,"onError",n.hitch(this,function(a){a.errors=a.errors||[];a.errors.push({message:"This application does not have a valid Bing Key for the Bing layer that is included in this map. [type:"+a.type+"]"})},a))):(a.errors=a.errors||[],a.errors.push({message:"This application does not provide a Bing Key for the Bing layer that is included in this map. [type:"+a.type+"]"})):a.resourceInfo&&a.resourceInfo.mapName?d=!0===a.resourceInfo.singleFusedMapCache&&(a.baseMapLayer||
ea(a,f,c)&&fa(a,b,g))?ca(a,m,e):oa(a,m,e):a.resourceInfo&&a.resourceInfo.pixelSizeX?d=!0===a.resourceInfo.singleFusedMapCache&&(a.baseMapLayer||ea(a,f,c)&&fa(a,b,g))?ca(a,m,e):jb(a,m,e):a.resourceInfo&&"Feature Layer"===a.resourceInfo.type?(a.capabilities&&(a.resourceInfo.capabilities=a.capabilities),d=new w(B(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,mode:a.mode===w.MODE_SELECTION?w.MODE_SELECTION:w.MODE_AUTO,editable:!1===e.editable?!1:void 0,outFields:["*"],
autoGeneralize:!0,refreshInterval:a.refreshInterval}),!e.ignorePopups&&a.popupInfo&&d.setInfoTemplate(new m(a.popupInfo)),a.layerDefinition&&(a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&(c=I.fromJson(a.layerDefinition.drawingInfo.renderer),c.isMaxInclusive=!0,d.setRenderer(c)),a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.labelingInfo&&(c=k.map(a.layerDefinition.drawingInfo.labelingInfo,function(a){return new Ka(a)}),d.setLabelingInfo(c)),a.layerDefinition.definitionExpression&&
d.setDefinitionExpression(a.layerDefinition.definitionExpression),l.isDefined(a.layerDefinition.minScale)&&d.setMinScale(a.layerDefinition.minScale),l.isDefined(a.layerDefinition.maxScale)&&d.setMaxScale(a.layerDefinition.maxScale)),Ja(d)):a.resourceInfo&&a.resourceInfo.streamUrls&&(c={resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id},a.layerDefinition&&(r=a.layerDefinition.drawingInfo,a.layerDefinition.definitionGeometry&&(h=h||{},h.geometry=a.layerDefinition.definitionGeometry),
l.isDefined(a.layerDefinition.definitionExpression)&&(h=h||{},h.where=a.layerDefinition.definitionExpression),l.isDefined(a.layerDefinition.maximumTrackPoints)&&(c.maximumTrackPoints=a.layerDefinition.maximumTrackPoints)),h&&(c.filter=h),a.purgeOptions&&(c.purgeOptions=a.purgeOptions),d=new La(B(a.url),c),r&&r.renderer&&(c=r.renderer,d.setRenderer(I.fromJson(c))),!e.ignorePopups&&a.popupInfo&&d.setInfoTemplate(new m(a.popupInfo)),a.layerDefinition&&(l.isDefined(a.layerDefinition.minScale)&&d.setMinScale(a.layerDefinition.minScale),
l.isDefined(a.layerDefinition.maxScale)&&d.setMaxScale(a.layerDefinition.maxScale)),U.once(d,"error",function(b){a.errors.push({message:"Error loading stream layer. Check websocket url"})}));d&&(d.arcgisProps={title:a.title},a.baseMapLayer&&(a.isReference?(d.attr("data-reference",!0),d._basemapGalleryLayerType="reference"):d._basemapGalleryLayerType="basemap"));return d}function ga(a,f,e,c,b){k.forEach(a,function(d){d.layerObject=ya(d,a,f,e,c,b)});var g=k.filter(a,function(a){return!a.isReference}),
d=k.filter(a,function(a){return!!a.isReference});return a=g.concat(d)}function ha(a){var f=null;a=a[0];a.url&&!a.type?a.resourceInfo.spatialReference&&(f=new C,a.resourceInfo.spatialReference.wkid&&(f.wkid=a.resourceInfo.spatialReference.wkid),a.resourceInfo.spatialReference.wkt&&(f.wkt=a.resourceInfo.spatialReference.wkt)):a.type&&(-1<a.type.indexOf("BingMaps")||"OpenStreetMap"==a.type?f=new C({wkid:102100}):"WMS"==a.type&&(f=new C({wkid:a.spatialReferences[0]})));return f}function Ma(a,f,e,c,b,
g,d,h){k.forEach(f,function(b){b.url&&!b.type&&(b.resourceInfo=a[b.deferredsPos][1],delete b.deferredsPos)});g=g||ha(f);f=ga(f,e,g,d,h);b.callback(f);return b}function Ja(a){!window.CanvasRenderingContext2D&&a.renderer&&"esri.renderer.HeatmapRenderer"===a.renderer.declaredClass&&a.setRenderer(I.fromJson({type:"simple",symbol:{color:[77,77,77,255],size:6,angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[255,255,255,255],width:.75,type:"esriSLS",style:"esriSLSSolid"}}}))}
function Na(a,f){var e=B(a);return A({url:e,content:{f:"json"},callbackParamName:"callback",error:function(a,b){a.message=a.message?a.message+(" [url:"+e+"]"):"[url:"+e+"]";f.push(a);L.defaults.io.errorHandler(a,b)}})}function Oa(a){var f=t.arcgisUrl+"/"+a.itemId+"/data";return A({url:f,content:{f:"json"},callbackParamName:"callback",error:function(e,c){e.message=e.message?e.message+(" [url:"+f+"]"):"[url:"+f+"]";a.errors=a.errors||[];a.errors.push(e);L.defaults.io.errorHandler(e,c)}})}function Pa(a,
f,e){var c=new q;if(!(e.featureCollection&&e.featureCollection.layers||e.layers))return console.log("Invalid Feature Collection item data [item id: "+a.itemId+"]: ",e),a.errors=a.errors||[],a.errors.push({message:"Invalid Feature Collection item data. [item id: "+a.itemId+"]"}),c.errback(),c;e.layers&&(e.featureCollection={layers:e.layers},delete e.layers,l.isDefined(e.showLegend)&&(e.featureCollection.showLegend=e.showLegend,delete e.showLegend));Qa(a,e.featureCollection,f).then(function(b){e.featureCollection=
b;a.featureCollection&&a.featureCollection.layers?k.forEach(e.featureCollection.layers,function(b,c){var d=a.featureCollection.layers[c];d.popupInfo||d.layerDefinition?d.layerDefinition?(l.isDefined(d.layerDefinition.minScale)&&l.isDefined(d.layerDefinition.maxScale)&&(d.layerDefinition.minScale!==b.layerDefinition.minScale||d.layerDefinition.maxScale!==b.layerDefinition.maxScale)&&(delete b.layerDefinition.minScale,delete b.layerDefinition.maxScale),d.layerDefinition.drawingInfo&&K.toJson(d.layerDefinition.drawingInfo)!==
K.toJson(b.layerDefinition.drawingInfo)&&delete b.layerDefinition.drawingInfo,d.layerDefinition.showLegend!==b.layerDefinition.showLegend&&delete b.layerDefinition.showLegend,d.layerDefinition=n.mixin(d.layerDefinition,b.layerDefinition)):d.layerDefinition=b.layerDefinition:(d.popupInfo=b.popupInfo,d.layerDefinition=b.layerDefinition);d.featureSet=b.featureSet;d.nextObjectId=b.nextObjectId}):(a.featureCollection=a.featureCollection||{},a.featureCollection=n.mixin(a.featureCollection,e.featureCollection));
c.callback(a)});return c}function Qa(a,f,e){var c=new q;J(["./csv"],function(b){var g=[];k.forEach(f.layers,function(a){a.featureSet&&a.featureSet.features&&a.featureSet.features.length&&a.featureSet.features[0].geometry&&a.featureSet.features[0].geometry.spatialReference&&(a.deferredsPos=g.length,g.push(b.projectFeatureCollection(a,e,a.featureSet.features[0].geometry.spatialReference)))});(new D(g)).addCallback(function(){k.forEach(f.layers,function(b){l.isDefined(b.deferredsPos)&&(g[b.deferredsPos].results&&
g[b.deferredsPos].results.length?b=g[b.deferredsPos].results[0]:(console.log("Errors projecting feature collection. ["+a.title+" - "+b.layerDefinition.name+"]"),b.errors=b.errors||[],b.errors.push({message:"Errors projecting feature collection. ["+a.title+" - "+b.layerDefinition.name+"]"})),delete b.deferredsPos)});c.callback(f)})});return c}function Q(a,f,e,c,b){var g=new q,d=new q,h=[],m;k.forEach(a.operationalLayers,function(a){a.itemId&&"Feature Collection"==a.type&&h.push(Oa(a).then(n.hitch(null,
Pa,a,e)))});0===h.length?Ra(a,f,e,c,d,b):(m=new D(h),m.addCallback(function(g){Ra(a,f,e,c,d,b)}));d.then(function(a){h=[];k.forEach(a,function(a){var b;a=a.layerObject;a instanceof w&&!a.loaded&&!a.loadError?(b=new q,U.once(a,"load, error",function(){b.callback(a)}),h.push(b)):a&&"esri.layers.WFSLayer"===a.declaredClass&&!a.loadError&&(b=new q,U.once(a,"fromJsonComplete, error",function(c){b.callback(a)}),h.push(b))});if(h.length){var b=new q;m=new D(h);m.addCallback(function(){b.callback(a)});return b.promise}return a}).then(function(a){var b=
[];k.forEach(a,function(a){var c=a.layerObject;c instanceof w?c.loaded&&c.labelingInfo&&(a.showLabels||c._collection)&&b.push(c):c&&"esri.layers.WFSLayer"===c.declaredClass&&c.loaded&&c.labelingInfo&&b.push(c)});b.length?J(["../layers/LabelLayer"],function(c){var d=new c;k.forEach(b,function(a){d.addFeatureLayer(a)});a.push({layerObject:d});g.callback(a)}):g.callback(a)});return g}function Ra(a,f,e,c,b,g){var d=[],h=[],m=[];k.forEach(a.operationalLayers,function(a,b){if(a.featureCollection&&a.featureCollection.layers){var c=
a.featureCollection.layers.length;k.forEach(a.featureCollection.layers,function(d,e){var f=!0;a.visibleLayers&&-1==k.indexOf(a.visibleLayers,e)&&(f=!1);d.visibility=a.visibility&&f;d.opacity=a.opacity;d.id=(a.id||"operational"+b)+"_"+e;a.title&&(d.title=1!==c&&d.layerDefinition.name&&a.title!==d.layerDefinition.name?a.title+" - "+d.layerDefinition.name:a.title);m.push(d)},this)}else m.push(a)});k.forEach(a.baseMap.baseMapLayers,function(a,b){a.baseMapLayer=!0;a.id=a.id||"base"+b;d.push(a)});k.forEach(m,
function(a,b){a.id=a.id||"operational"+b;d.push(a)});k.forEach(d,function(a){a.url&&!a.type&&(a.deferredsPos=h.length,a.errors=a.errors||[],h.push(Na(a.url,a.errors)))});0===h.length?(e=e||ha(d),d=ga(d,f,e,c,g),b.callback(d)):(new D(h)).addCallback(function(a){Ma(a,d,f,h,b,e,c,g)});return b}function R(a,f,e,c){var b=a.minScale,g=a.maxScale;if(10.1>=e.version&&f)for(a=f.length-1;0<=a;a--){if(f[a].id==c)if(0==b&&0<f[a].minScale?b=f[a].minScale:0<b&&0==f[a].minScale?b=e.minScale:0<b&&0<f[a].minScale&&
(b=Math.min(b,f[a].minScale)),g=Math.max(e.maxScale||0,f[a].maxScale||0),e.setScaleRange(b,g),-1<f[a].parentLayerId)c=f[a].parentLayerId;else break}else 10.1<e.version&&(k.forEach(a.layerInfos,function(a){a.id==c&&(0==b&&0<a.minScale?b=a.minScale:0<b&&0==a.minScale||0<b&&0<a.minScale&&(b=Math.min(b,a.minScale)),g=Math.max(g||0,a.maxScale||0))}),e.setScaleRange(b,g))}function S(a,f,e,c){var b=a.url,g=a.__popupIds,d=a.__popupUrls,h=a.__popupWhereClauses,m=a.__popupMinScales,x=a.__popupMaxScales,p=a.__resourceInfo,
r=[];k.forEach(a.__popups,function(c,n){if(c){var v,t=[];k.forEach(c.fieldInfos,function(a){"shape"!==a.fieldName.toLowerCase()&&t.push(a.fieldName)});if(a.dynamicLayerInfos&&0<a.dynamicLayerInfos.length){var q=k.filter(a.dynamicLayerInfos,function(a){return g[n]==a.id})[0].source;v=new w(b+"/dynamicLayer",{id:a.id+"_"+g[n],source:q,outFields:t,mode:w.MODE_SELECTION,infoTemplate:c&&new e(c),drawMode:!1,visible:a.visible,autoGeneralize:!0});var y=function(b,c){0<h[b].length&&c.setDefinitionExpression(h[b]);
if(l.isDefined(m[b])||l.isDefined(x[b]))if(l.isDefined(a.minScale)||l.isDefined(a.maxScale)){var d=a.minScale,e=a.maxScale;0==d&&0<m[b]?d=m[b]:0<d&&0==m[b]||0<d&&0<m[b]&&(d=Math.min(d,m[b]));e=Math.max(e||0,x[b]||0);c.setScaleRange(d,e)}else c.setScaleRange(m[b],x[b]);else R(a,f||p.layers,c,g[b])};v.loaded?y(n,v):u.connect(v,"onLoad",function(a){y(n,v)})}else{var z=null,A=b+"/"+g[n];if(d[n].length)A=d[n];else if(f)for(q=0;q<f.length;q++)if(f[q].id===g[n]){z=f[q];break}v=new w(B(A),{id:a.id+"_"+g[n],
outFields:t,mode:w.MODE_SELECTION,infoTemplate:c&&new e(c),drawMode:!1,visible:a.visible,resourceInfo:z,autoGeneralize:!0});v.loaded?(0<h[n].length&&v.setDefinitionExpression(h[n]),R(a,f||p.layers,v,g[n])):u.connect(v,"onLoad",function(b){0<h[n].length&&v.setDefinitionExpression(h[n]);R(a,f||p.layers,b,g[n])})}r.push(v)}});0<r.length&&(u.connect(a,"onVisibilityChange",n.hitch(this,function(a,b){k.forEach(a,function(a){b?a.show():a.hide()})},r)),u.connect(c,"onLayerRemove",n.hitch(this,function(a,
b,d){a.id===d.id&&k.forEach(b,function(a){c.removeLayer(a)})},a,r)));delete a.__popups;delete a.__popupIds;delete a.__popupUrls;delete a.__popupWhereClauses;delete a.__popupMinScales;delete a.__popupMaxScales;delete a.__resourceInfo;return r}function Sa(a){return A({url:B(a.url+"/layers"),content:{f:"json"},callbackParamName:"callback",error:function(){}})}function Ta(a,f,e){var c=[];k.forEach(a,function(a){var b=a.__popups;b&&1<b.length&&10<=a.version&&(a.__deferredsPos=c.length,c.push(Sa(a)))});
var b=[];0<c.length?(new D(c)).addCallback(function(c){k.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(a.__deferredsPos||0===a.__deferredsPos?(b=b.concat(S(a,c[a.__deferredsPos][1].layers,e,f)),delete a.__deferredsPos):b=b.concat(S(a,null,e,f)))});f.addLayers(b)}):(k.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(b=b.concat(S(a,null,e,f)))}),f.addLayers(b))}function Ua(a){k.forEach(a,function(a){var e=a.layer;e.toJson&&(a=e.toJson(),a.featureSet&&e.name&&-1<e.name.indexOf("Text")&&
k.forEach(a.featureSet.features,function(a,b){if(a.attributes.TEXT){var c=e.graphics[b];c.symbol.setText(a.attributes.TEXT);a.symbol.horizontalAlignment&&(c.symbol.align=a.symbol.horizontalAlignment);c.setSymbol(c.symbol);c.setAttributes(a.attributes)}},this))})}function Va(a){var f=6;k.forEach(a,function(a){if(a=a.renderer)"esri.renderer.SimpleRenderer"===a.declaredClass?((a=a.symbol)&&a.xoffset&&(f=Math.max(f,Math.abs(a.xoffset))),a&&a.yoffset&&(f=Math.max(f,Math.abs(a.yoffset)))):"esri.renderer.UniqueValueRenderer"!==
a.declaredClass&&"esri.renderer.ClassBreaksRenderer"!==a.declaredClass||k.forEach(a.infos,function(a){(a=a.symbol)&&a.xoffset&&(f=Math.max(f,Math.abs(a.xoffset)));a&&a.yoffset&&(f=Math.max(f,Math.abs(a.yoffset)))})});return f}function ia(a){var f=this,e=f.infoWindow,c=a.graphic;if(f.loaded){e.hide();e.clearFeatures();var b=[];k.forEach(f.graphicsLayerIds,function(a){(a=f.getLayer(a))&&a instanceof w&&a.loaded&&a.visible&&(a.clearSelection(),a.infoTemplate&&!a.suspended&&b.push(a))});k.forEach(f.layerIds,
function(a){(a=f.getLayer(a))&&-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")&&a.loaded&&a.visible&&a.infoTemplate&&b.push(a)});c=c&&c.getInfoTemplate()?c:null;if(b.length||c){var g=Va(b),d=a.screenPoint,h=f.toMap(new ja(d.x-g,d.y+g)),g=f.toMap(new ja(d.x+g,d.y-g)),h=new E(h.x,h.y,g.x,g.y,f.spatialReference),m=new eb;m.geometry=h;m.timeExtent=f.timeExtent;var l=!0,h=k.map(b,function(b){var c;-1!==b.declaredClass.indexOf("ArcGISImageServiceLayer")?(m.geometry=a.mapPoint,l=!1,c=b.queryVisibleRasters(m,
{rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0}),c.addCallback(function(){return b.getVisibleRasters()})):(c=b.selectFeatures(m),c.addCallback(function(){return b.getSelectedFeatures()}));return c});c&&(g=new q,g.callback([c]),h.splice(0,0,g));if(!k.some(h,function(a){return-1===a.fired})){var p=c?1:0;k.forEach(b,function(a){p=-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")?p+a.getVisibleRasters().length:p+a.getSelectedFeatures().length});if(!p)return}e.setFeatures(h);e.show(a.mapPoint,
{closestFirst:l})}}}function kb(a,f){var e=f.mapOptions||{},c;e.infoWindow||(c=new db({visibleWhenEmpty:!1},$a.create("div")),e.infoWindow=c);l.isDefined(e.showInfoWindowOnClick)||f.usePopupManager||(e.showInfoWindowOnClick=!1);e=new bb(a,e);u.connect(e,"onLayersAddResult",Ua);return e}function z(a,f,e,c,b,g){var d,h,m,l;c.map?(d=c.map,h=c.clickEventHandle,m=c.clickEventListener,l=c.errors):(d=kb(c,b),b.ignorePopups||b.disableClickBehavior||b.usePopupManager||(h=u.connect(d,"onClick",ia),m=ia));d.addLayers(a);
b.ignorePopups||b.usePopupManager||Ta(a,d,b._clazz);var p=l||[];k.forEach(f,function(a){a.errors&&(p=p.concat(a.errors))},this);d.loaded?g.callback({map:d,itemInfo:e,errors:p,clickEventHandle:h,clickEventListener:m}):u.connect(d,"onLoad",function(){g.callback({map:d,itemInfo:e,errors:p,clickEventHandle:h,clickEventListener:m})})}function T(a,f,e,c,b){var g=[];k.forEach(b,function(a){n.isArray(a.layerObject)?k.forEach(a.layerObject,function(a){g.push(a)}):g.push(a.layerObject)});if("BingMapsAerial"===
b[0].type||"BingMapsRoad"===b[0].type||"BingMapsHybrid"===b[0].type)var d=setInterval(function(){if(b[0].layerObject&&b[0].layerObject.loaded)clearInterval(d),Wa(a,f,e,c,b,g);else if(b[0].errors){clearInterval(d);var h="";b[0].errors&&b[0].errors.length&&(h=" ("+b[0].errors[0].message+")");c.errback(Error(W.arcgis.utils.baseLayerError+h))}},10);else if(!g[0]&&b[0].baseMapLayer){var h="";b[0].errors&&b[0].errors.length&&(h=" ("+b[0].errors[0].message+")");c.errback(Error(W.arcgis.utils.baseLayerError+
h))}else Wa(a,f,e,c,b,g)}function Wa(a,f,e,c,b,g){try{var d=e.mapOptions||{};e.mapOptions=d;var h=a.item,m=a.itemData;!d.backgroundColor&&m.background&&m.background.color&&null!=m.background.color[0]&&(d.backgroundColor=ab.toDojoColor(m.background.color));g=k.filter(g,l.isDefined);if(h)if(h.extent&&h.extent.length)if(d.extent)z(g,b,a,f,e,c);else{var n=new E(h.extent[0][0],h.extent[0][1],h.extent[1][0],h.extent[1][1],new C({wkid:4326})),p=g[0].spatialReference;4326===p.wkid?(d.extent=n,z(g,b,a,f,e,
c)):102100===p.wkid||102113===p.wkid||3857===p.wkid?(n.xmin=Math.max(n.xmin,-180),n.xmax=Math.min(n.xmax,180),n.ymin=Math.max(n.ymin,-89.99),n.ymax=Math.min(n.ymax,89.99),d.extent=cb.geographicToWebMercator(n),z(g,b,a,f,e,c)):e.geometryServiceURL||L.defaults.geometryService?(e.geometryServiceURL?new fb(e.geometryServiceURL):L.defaults.geometryService).project([n],p,function(h){h=h[0];d.extent=d.extent||h;z(g,b,a,f,e,c)},function(){z(g,b,a,f,e,c)}):c.errback(Error(W.arcgis.utils.geometryServiceError))}else z(g,
b,a,f,e,c);else z(g,b,a,f,e,c)}catch(r){c.errback(r)}}function lb(a){var f=[];k.forEach(a.operationalLayers,function(a){a.featureCollection?f.push({featureCollection:a.featureCollection,visibility:a.visibility,title:a.title}):a.layerObject&&f.push({layer:a.layerObject,visibility:a.visibility,title:a.title})});return f}function Xa(a){var f=[];a=a.baseMap.baseMapLayers.concat(a.operationalLayers);k.forEach(a,function(a){var c={};if(a.featureCollection&&"CSV"!==a.type)!0===a.featureCollection.showLegend&&
k.forEach(a.featureCollection.layers,function(b){if(!1!==b.showLegend){var d=b.layerObject.renderer;c={layer:b.layerObject,title:a.title,defaultSymbol:d&&d.defaultSymbol&&d.defaultLabel?!0:!1};1<a.featureCollection.layers.length&&(c.title+=" - "+b.layerDefinition.name);f.push(c)}});else if(a.baseMapLayer&&!0===a.showLegend&&a.layerObject||!a.baseMapLayer&&!1!==a.showLegend&&a.layerObject&&!(a.layerObject instanceof w&&a.layerObject.mode===w.MODE_SELECTION)){var b=a.layerObject.renderer,e=a.layerObject.declaredClass,
b=!b||b&&b.defaultSymbol&&b.defaultLabel?!0:!1;if(10.1>a.layerObject.version&&("esri.layers.ArcGISDynamicMapServiceLayer"===e||"esri.layers.ArcGISTiledMapServiceLayer"===e)||"esri.layers.ArcGISImageServiceLayer"===e)b=!0;c={layer:a.layerObject,title:a.title,defaultSymbol:b};a.layers&&(e=k.map(k.filter(a.layers,function(a){return!1===a.showLegend}),function(a){return a.id}),e.length&&(c.hideLayers=e));f.push(c)}});return f}function mb(a,f){function e(a,b){k.forEach(a,function(a,c){switch(a){case "../layers/ArcGISDynamicMapServiceLayer":qa=
b[c];break;case "../layers/ArcGISImageServiceLayer":xa=b[c];break;case "../layers/ArcGISImageServiceVectorLayer":wa=b[c];break;case "./csv":Ha=b[c];break;case "../layers/CSVLayer":Ia=b[c];break;case "../layers/DynamicLayerInfo":ra=b[c];break;case "../layers/GeoRSSLayer":Ga=b[c];break;case "../layers/ImageParameters":pa=b[c];break;case "../layers/ImageServiceParameters":ta=b[c];break;case "../layers/KMLLayer":Da=b[c];break;case "../layers/LabelClass":Ka=b[c];break;case "../layers/LayerDrawingOptions":sa=
b[c];break;case "../layers/MosaicRule":va=b[c];break;case "../layers/OpenStreetMapLayer":za=b[c];break;case "../layers/RasterFunction":ua=b[c];break;case "../layers/StreamLayer":La=b[c];break;case "../layers/TileInfo":Fa=b[c];break;case "../layers/VectorTileLayer":P=b[c];break;case "../virtualearth/VETiledLayer":y=b[c];break;case "../layers/WebTiledLayer":Ea=b[c];break;case "../layers/WFSLayer":Aa=b[c];break;case "../layers/WMSLayer":Ca=b[c];break;case "../layers/WMSLayerInfo":Ba=b[c]}})}var c=new q,
b=a.itemData,g=[];b.baseMap&&b.baseMap.baseMapLayers&&(g=g.concat(b.baseMap.baseMapLayers));b.operationalLayers&&(g=g.concat(b.operationalLayers));for(var b=k.map(g,function(a){return a&&a.layerType}),d=[],h=[],g=!1,m=0;m<b.length;m++){switch(b[m]){case "ArcGISFeatureLayer":-1===k.indexOf(d,"../layers/LabelClass")&&d.push("../layers/LabelClass");break;case "ArcGISImageServiceLayer":case "ArcGISTiledImageServiceLayer":-1===k.indexOf(d,"../layers/ArcGISImageServiceLayer")&&(d.push("../layers/ArcGISImageServiceLayer"),
h.push("../layers/ImageServiceParameters"),h.push("../layers/MosaicRule"),h.push("../layers/RasterFunction"));break;case "ArcGISImageServiceVectorLayer":-1===k.indexOf(d,"../layers/ArcGISImageServiceVectorLayer")&&(d.push("../layers/ArcGISImageServiceVectorLayer"),h.push("../layers/ImageServiceParameters"),h.push("../layers/MosaicRule"),h.push("../layers/RasterFunction"));break;case "ArcGISMapServiceLayer":case "ArcGISTiledMapServiceLayer":-1===k.indexOf(d,"../layers/ArcGISDynamicMapServiceLayer")&&
(d.push("../layers/ArcGISDynamicMapServiceLayer"),h.push("../layers/DynamicLayerInfo"),h.push("../layers/ImageParameters"),h.push("../layers/LayerDrawingOptions"));break;case "ArcGISStreamLayer":-1===k.indexOf(d,"../layers/StreamLayer")&&d.push("../layers/StreamLayer");break;case "BingMapsAerial":case "BingMapsHybrid":case "BingMapsRoad":-1===k.indexOf(d,"../virtualearth/VETiledLayer")&&d.push("../virtualearth/VETiledLayer");break;case "CSV":-1===k.indexOf(d,"../layers/CSVLayer")&&(d.push("../layers/CSVLayer"),
h.push("./csv"));break;case "GeoRSS":-1===k.indexOf(d,"../layers/GeoRSSLayer")&&d.push("../layers/GeoRSSLayer");break;case "KML":-1===k.indexOf(d,"../layers/KMLLayer")&&d.push("../layers/KMLLayer");break;case "OpenStreetMap":-1===k.indexOf(d,"../layers/OpenStreetMapLayer")&&d.push("../layers/OpenStreetMapLayer");break;case "VectorTileLayer":-1===k.indexOf(d,"../layers/VectorTileLayer")&&d.push("../layers/VectorTileLayer");break;case "WebTiledLayer":-1===k.indexOf(d,"../layers/WebTiledLayer")&&(d.push("../layers/WebTiledLayer"),
h.push("../layers/TileInfo"));break;case "WFS":-1===k.indexOf(d,"../layers/WFSLayer")&&d.push("../layers/WFSLayer");break;case "WMS":-1===k.indexOf(d,"../layers/WMSLayer")&&(d.push("../layers/WMSLayer"),h.push("../layers/WMSLayerInfo"));break;default:g=!0}if(g)break}g&&(d=nb,h=ob);d.length?J(d,function(){e(d,arguments);h.length?J(h,function(){e(h,arguments);c.resolve()}):c.resolve()}):c.resolve();return c}function Ya(a,f,e,c){var b=c.itemData;b.baseMap&&b.baseMap.baseMapLayers&&b.baseMap.baseMapLayers.length&&
(b.baseMap.baseMapLayers[0].firstLayer=!0);var g=f.layerMixins,d=g&&g.length;if(d){var h=function(a){for(var b=0;b<d;b++){var c=g[b];if(c.mixin)if(c.hasOwnProperty("id")){if(a.id===c.id){n.mixin(a,c.mixin);break}}else if(a.url===c.url){n.mixin(a,c.mixin);break}}};k.forEach(b.baseMap&&b.baseMap.baseMapLayers,h);k.forEach(b.operationalLayers,h)}mb(c,f).then(function(){return ib(c,f)}).then(function(){return hb(c,f)}).then(function(b){var c=b[0],d=b[1];if(c.itemData.operationalLayers&&0!==c.itemData.operationalLayers.length){var f=
new q,g=c.itemData.baseMap.baseMapLayers.slice(),h=k.filter(c.itemData.baseMap.baseMapLayers,function(a){return!a.isReference});b={item:c.item,itemData:{baseMap:{baseMapLayers:h}}};c.itemData.baseMap.baseMapLayers=k.filter(c.itemData.baseMap.baseMapLayers,function(a){return a.isReference});M(b,d).addCallback(function(b){Q(b.itemData,d).addCallback(n.hitch(null,T,b,a,d,f))});f.then(function(a){M(c,d).addCallback(function(b){Q(b.itemData,d,a.map.spatialReference,h,a.map).addCallback(function(c){b.itemData.baseMap.baseMapLayers=
g;T(b,a,d,e,c)})})},n.hitch(e,e.errback))}else M(c,d).addCallback(function(b){Q(b.itemData,d).addCallback(n.hitch(null,T,b,a,d,e))})})}function aa(a,f){"undefined"===typeof f&&(f=!0);t._arcgisUrl&&0<t._arcgisUrl.length&&(t.arcgisUrl=t._arcgisUrl);var e=t.arcgisUrl+"/"+a,c={},b=new q;A({url:e,content:{f:"json"},callbackParamName:"callback",load:function(a){c.item=a;f?A({url:e+"/data",content:{f:"json"},callbackParamName:"callback",load:function(a){c.itemData=a;b.callback(c)},error:function(a){b.errback(a)}}):
b.callback(c)},error:function(a){b.errback(a)}});return b}var t,qa,xa,wa,Ha,Ia,ra,Ga,pa,ta,Da,Ka,sa,va,za,ua,La,Fa,P,y,Ea,Aa,Ca,Ba,nb="../layers/ArcGISDynamicMapServiceLayer ../layers/ArcGISImageServiceLayer ../layers/ArcGISImageServiceVectorLayer ../layers/CSVLayer ../layers/GeoRSSLayer ../layers/KMLLayer ../layers/LabelClass ../layers/OpenStreetMapLayer ../layers/StreamLayer ../layers/VectorTileLayer ../virtualearth/VETiledLayer ../layers/WebTiledLayer ../layers/WFSLayer ../layers/WMSLayer".split(" "),
ob="./csv ../layers/DynamicLayerInfo ../layers/ImageParameters ../layers/ImageServiceParameters ../layers/LayerDrawingOptions ../layers/MosaicRule ../layers/RasterFunction ../layers/TileInfo ../layers/WMSLayerInfo".split(" ");t={arcgisUrl:V.getProtocolForWebResource()+"//www.arcgis.com/sharing/rest/content/items",getItem:aa,createMap:function(a,f,e){var c=new q;e=e||{};var b=e.infoTemplateClass;e._clazz=b&&(n.isObject(b)?b:n.getObject(b))||ka;n.isString(a)?aa(a).addCallback(n.hitch(null,Ya,f,e,c)).addErrback(n.hitch(c,
c.errback)):Ya(f,e,c,a);return c},getLayerList:function(a){return a&&a.itemInfo&&a.itemInfo.itemData?lb(a.itemInfo.itemData):[]},getLegendLayers:function(a){return a&&a.itemInfo&&a.itemInfo.itemData?Xa(a.itemInfo.itemData):[]},_arcgisUrl:null,_getItemProps:M,_getItemData:G,_getBingKey:X,_portalUrlResponse:Z,_portalUrlFailure:N,_processFSItemProperties:Y,_processSSItemProperties:la,_getLayers:Q,_preBuildLayerObjects:Ma,_buildLayerObjects:ga,_preCreateMap:T,_getMapSR:ha,_createMap:z,_addSelectionLayers:Ta,
_createSelectionFeatureLayers:S,_getServiceInfo:Na,_getFeatureCollectionItem:Oa,_mergeFeatureCollectionItem:Pa,_projectFeatureCollection:Qa,_getLayersInfo:Sa,_initLayer:ya,_loadAsCached:ca,_loadAsDynamic:oa,_processPopups:ba,_onLayersAddResult:Ua,_sameSpatialReferenceAsBasemap:ea,_sameTilingSchemeAsBasemap:fa,_showPopup:ia,_calculateClickTolerance:Va,_getVisibleFeatureLayers:da,_updateLayerScaleInfo:R,_checkUrl:B,_isHostedService:ma,_isAgolService:na,_getLegendLayers:Xa};n.setObject("arcgis.utils",
t,H);return t});