// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.20/esri/copyright.txt for details.
//>>built
define("esri/request","require dojo/_base/array dojo/_base/config dojo/_base/Deferred dojo/_base/lang dojo/_base/url dojo/_base/xhr dojo/io/script dojo/io/iframe dojo/dom-construct dojo/io-query ./kernel ./config ./sniff ./lang ./urlUtils ./deferredUtils".split(" "),function(X,D,N,R,t,Y,u,Z,aa,S,T,h,ba,l,B,r,ca){function v(a){a=new Y(a);return(a.host+(a.port?":"+a.port:"")).toLowerCase()}function da(a){return this._xhr?this._xhr.getResponseHeader(a):null}function E(a,c,e,f){var m=!1,p=!1,x;B.isDefined(c)&&
(t.isObject(c)?(m=!!c.useProxy,p=!!c.usePost,x=c.crossOrigin):m=!!c);a=t.mixin({},a);a._ssl&&(a.url=a.url.replace(/^http:/i,"https:"));10>l("ie")&&!ea.test(a.url)&&(a.url=encodeURI(a.url));c=a.content;var k=a.url,g=e&&a.form,w=n;x=B.isDefined(x)?x:w.useCors;a.load=function(a){var b;a&&(a.error?(b=t.mixin(Error(),a.error),b.log=N.isDebug):"error"===a.status&&(b=t.mixin(Error(),a),b.log=N.isDebug),b&&!B.isDefined(b.httpCode)&&(b.httpCode=b.code));return b||a};a.error=function(a,b){b&&b.xhr&&b.xhr.abort();
a instanceof Error||(a=t.mixin(Error(),a));a.log=N.isDebug;w.errorHandler(a,b);return a};a._token&&(a.content=a.content||{},a.content.token=a._token);var q=0,F;c&&k&&(F=T.objectToQuery(c),q=F.length+k.length+1,l("esri-url-encodes-apostrophe")&&(q=F.replace(/'/g,"%27").length+k.length+1));a.timeout=B.isDefined(a.timeout)?a.timeout:w.timeout;a.handleAs=a.handleAs||"json";try{var y,z,b=x&&r.canUseXhr(a.url)&&!/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i.test(a.url),d=r.hasSameOrigin(a.url,window.location.href)||
b,G=p||e||q>w.postLength?!0:!1,U=d||-1===a.handleAs.indexOf("json")||!a.callbackParamName||e?!1:!0,H=r.getProxyRule(a.url)||w.alwaysUseProxy||m||(!U||G)&&!d?!0:!1;e&&!l("esri-file-upload")&&!H&&b&&(H=!0);if(H)if(y=r.getProxyUrl(k,x),z=y.path,y._xo&&(b=!0),!G&&z.length+1+q>w.postLength&&(G=!0),a.url=z+"?"+k,G)a.content=t.mixin(y.query||{},c);else{var V=T.objectToQuery(t.mixin(y.query||{},c));V&&(a.url+="?"+V);a.content=null}if(U&&!G)return!B.isDefined(a.isAsync)&&4>l("ff")&&(a.isAsync=!0),Z.get(A?
A(a):a);var I=a.headers;!b||I&&I.hasOwnProperty("X-Requested-With")||(I=a.headers=I||{},I["X-Requested-With"]=null);if(e){var v=a.callbackParamName||"callback.html",E=a.callbackElementName||"textarea",J,O,K,P,L=g.elements?g.elements.length:0,C;if(c=a.content)for(J in c)if(K=c[J],B.isDefined(K)){O=null;for(P=0;P<L;P++)if(C=g.elements[P],C.name===J){O=C;break}O?O.value=K:f?g.append(J,K):g.appendChild(S.create("input",{type:"hidden",name:J,value:K}))}if(l("esri-file-upload"))D.forEach(g.elements,function(a){a.name===
v&&g.removeChild(a)}),a.contentType=!1,a.postData=f?g:new FormData(g),delete a.form;else{g.enctype="multipart/form-data";9>l("ie")&&(g.encoding="multipart/form-data");g.method="post";D.some(g.elements,function(a){return a.name===v})||g.appendChild(S.create("input",{type:"hidden",name:v,value:E}));if(-1!==k.toLowerCase().indexOf("addattachment")||-1!==k.toLowerCase().indexOf("updateattachment"))a.url=k+(-1===k.indexOf("?")?"?":"\x26")+v+"\x3d"+E,H&&(a.url=z+"?"+a.url);delete a.content}}if(b&&!a.hasOwnProperty("withCredentials")&&
"with-credentials"===n.useCors){f=H?z:k;var M=r.canUseXhr(f,!0),Q=-1<M?n.corsEnabledServers[M]:null;if(Q&&Q.hasOwnProperty("withCredentials"))Q.withCredentials&&(a.withCredentials=!0);else if(h.id){var W=h.id.findServerInfo(f);W&&W.webTierAuth&&(a.withCredentials=!0)}}a=A?A(a):a;if(G){if(e&&!l("esri-file-upload"))return aa.send(a);!H&&l("safari")&&(a.url+=(-1===a.url.indexOf("?")?"?":"\x26")+"_ts\x3d"+(new Date).getTime()+ga++);return u.post(a)}return u.get(a)}catch(fa){return e=new R,e.errback(a.error(fa)),
e}}function L(a){var c=n.corsStatus,e=r.canUseXhr(a,!0);-1<e&&n.corsEnabledServers.splice(e,1);c[v(a)]=1;return e}function C(a){var c=n.corsStatus;if(n.corsDetection&&n.useCors)try{var e=v(a);!l("esri-cors")||!a||-1===a.toLowerCase().indexOf("/rest/services")||r.hasSameOrigin(a,window.location.href)||r.canUseXhr(a)||c[e]||(c[e]=-1,u.get({url:a.substring(0,a.toLowerCase().indexOf("/rest/")+6)+"info",content:{f:"json"},failOk:!0,handleAs:"json",headers:{"X-Requested-With":null}}).then(function(f){f?
(c[e]=2,r.canUseXhr(a)||n.corsEnabledServers.push(e)):c[e]=1},function(a){c[e]=1}))}catch(f){console.log("esri._detectCors: an unknown error occurred while detecting CORS support")}}function M(a){A=a}function p(a,c){function e(b){b._pendingDfd=E(a,c,A,w);if(!b._pendingDfd){b.ioArgs=b._pendingDfd&&b._pendingDfd.ioArgs;var d=Error("Deferred object is missing");d.log=N.isDebug;a._usrDfd=null;b.errback(d);b._pendingDfd=null;return b}b._pendingDfd.addCallback(function(d){b.ioArgs=b._pendingDfd&&b._pendingDfd.ioArgs;
a._usrDfd=null;c.returnFullResponse&&(d={data:d,_xhr:b.ioArgs&&b.ioArgs.xhr,getHeader:da});b.callback(d);b._pendingDfd=null}).addErrback(function(d){var e,f,g;d&&(e=d.code,f=d.subcode,g=(g=d.messageCode)&&g.toUpperCase());if(d&&403==e&&(4==f||d.message&&-1<d.message.toLowerCase().indexOf("ssl")&&-1===d.message.toLowerCase().indexOf("permission"))){if(!a._ssl){a._ssl=a._sslFromServer=!0;a._usrDfd=b;p(a,c);return}}else if(d&&415==d.status){if(L(a.url),!a._err415){a._err415=1;a._usrDfd=b;p(a,c);return}}else if(h.id&&
-1!==D.indexOf(h.id._errorCodes,e)&&!h.id._isPublic(a.url)&&!t&&(403!=e||-1===D.indexOf(ha,g)&&(!B.isDefined(f)||2==f&&a._token))){b._pendingDfd=h.id.getCredential(a.url,{token:a._token,error:d});b._pendingDfd.addCallback(function(d){a._token=d.token;a._usrDfd=b;a._credential=d;a._ssl=a._sslFromServer||d.ssl;p(a,c)}).addErrback(function(d){a._usrDfd=null;b.errback(d);b._pendingDfd=null});return}b.ioArgs=b._pendingDfd&&b._pendingDfd.ioArgs;a._usrDfd=null;b.errback(d);b._pendingDfd=null})}a.url=r.fixUrl(a.url);
c=c||{};var f,m=a.form,t=c.disableIdentityLookup,x=c._preLookup,k=!1;if(l("esri-workers")&&!1!==n.useWorkers)if(!0===c.useWorkers||!0===n.useWorkers)k=!0;else if(c.workerOptions){var g=c.workerOptions;if(g.callback||g.worker&&g.worker.worker instanceof Worker)k=!0}var w=m&&l("esri-file-upload")&&m instanceof FormData,A=m&&(m.elements?D.some(m.elements,function(a){return"file"===a.type}):w),F=-1!==a.url.toLowerCase().indexOf("token\x3d")||a.content&&a.content.token||A&&D.some(m.elements,function(a){return"token"===
a.name})?1:0;C(a.url);if(a._usrDfd)f=a._usrDfd;else{f=new R(ca._dfdCanceller);f.addCallback(function(b){if((/\/sharing\/rest\/accounts\/self/i.test(a.url)||/\/sharing\/rest\/portals\/self/i.test(a.url))&&!F&&!a._token&&b.user&&b.user.username){n.webTierAuthServers.push(v(a.url));b=n.corsEnabledServers;var d=r.canUseXhr(a.url,!0),c={host:v(a.url),withCredentials:!0};if(-1===d)b.push(c);else{var e=b[d];"object"===typeof e?e.withCredentials=!0:b.splice(d,1,c)}}if(b=a._credential)if(d=(d=h.id.findServerInfo(b.server))&&
d.owningSystemUrl)d=d.replace(/\/?$/,"/sharing"),(b=h.id.findCredential(d,b.userId))&&-1===h.id._getIdenticalSvcIdx(d,b)&&b.resources.splice(0,0,d)});f.addBoth(function(b){delete a._credential;!b||l("ie")&&b.nodeType||(b._ssl=a._ssl)});var y=a.load,z=a.error;y&&f.addCallback(function(a){var b=f._pendingDfd,b=b&&b.ioArgs;return y.call(b&&b.args,a,b)});z&&f.addErrback(function(a){var b=f._pendingDfd,b=b&&b.ioArgs;return z.call(b&&b.args,a,b)})}!h.id||F||a._token||h.id._isPublic(a.url)||t&&!x||!(m=h.id.findCredential(a.url))||
(a._token=m.token,a._ssl=m.ssl);k?c.workerOptions&&c.workerOptions.worker?(q||(q=u),u=c.workerOptions.worker,e(f)):X(["./workers/RequestClient"],function(a){q||(q=u);if(c.workerOptions){var b=c.workerOptions;u=a.getClient(b.callback,b.cbFunction)}else u=a.getClient();e(f)}):(q&&(u=q,q=null),e(f));return f}var q=null,A,n=ba.defaults.io,ha=["COM_0056","COM_0057"],ga=0,ea=/%[0-9A-F]{2}/i;p._request=E;p._disableCors=L;p._detectCors=C;p.setRequestPreCallback=M;l("extend-esri")&&(h.request=p,h._request=
E,h._disableCors=L,h._detectCors=C,h.setRequestPreCallback=M);return p});