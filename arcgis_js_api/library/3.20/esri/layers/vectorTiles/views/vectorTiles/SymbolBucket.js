// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.20/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/vectorTiles/SymbolBucket","require exports ../../core/tsSupport/extendsHelper ../../core/tsSupport/decorateHelper ./Bucket ./Geometry ./style/StyleLayer ./Placement ./GeometryUtils ./TextShaping dojox/string/BidiEngine".split(" "),function(z,N,G,O,H,B,E,F,w,I,J){function K(w,h){if(w.iconMosaicItem&&h.iconMosaicItem){if(w.iconMosaicItem.page!==h.iconMosaicItem.page)return w.iconMosaicItem.page<h.iconMosaicItem.page?-1:1}else{if(w.iconMosaicItem&&!h.iconMosaicItem)return 1;
if(!w.iconMosaicItem&&h.iconMosaicItem)return-1}return 0}var L=function(){return function(){}}(),M=function(){return function(w,h,a,f){this.line=h;this.shaping=w;this.iconMosaicItem=a;this.anchor=f}}();(function(){return function(){}})();z=function(z){function h(a,f,b,c,e,d,m,C){a=z.call(this,a,f)||this;a._markerRatio=1;a._markerMap=new Map;a._markerVertexBuffer=b;a._markerIndexBuffer=c;a._textVertexBuffer=e;a._textIndexBuffer=d;a._placementEngine=m;a._workerTileHandler=C;return a}G(h,z);Object.defineProperty(h.prototype,
"markerPageMap",{get:function(){return this._markerMap},enumerable:!0,configurable:!0});Object.defineProperty(h.prototype,"textIndexStart",{get:function(){return this._textTriangleElementsStart},enumerable:!0,configurable:!0});Object.defineProperty(h.prototype,"textIndexCount",{get:function(){return this._textTriangleElementsNum},enumerable:!0,configurable:!0});Object.defineProperty(h.prototype,"sdfMarker",{get:function(){return!1},enumerable:!0,configurable:!0});h.prototype.copy=function(a,f,b,c,
e){e=new h(this.layer,this.zoom,a,f,b,c,e,this._workerTileHandler);e.layerIndex=this.layerIndex;e.layerExtent=this.layerExtent;e._markerVertexStart=a.index;e._markerTriangleElementsStart=f.index;e._textVertexStart=b.index;e._textTriangleElementsStart=c.index;e._markerTriangleElementsNum=0;e._textTriangleElementsNum=0;e._symbolInstances=this._symbolInstances;e._glyphItems=this._glyphItems;e._textLayout=this._textLayout;e._markerLayout=this._markerLayout;e._isLinePlacement=this._isLinePlacement;e._avoidEdges=
this._avoidEdges;return e};h.prototype.getResources=function(a,f,b){var c=this.layer,e=this.zoom;a&&a.setExtent(this.layerExtent);for(var d=c.getLayoutValue("icon-image",e),m=c.getLayoutValue("text-field",e),C=c.getLayoutValue("text-font",e),c=c.getLayoutValue("text-transform",e),e=[],q=0,u=this._features;q<u.length;q++){var n=u[q],t=n.getGeometry(a);if(t&&0!==t.length){var k=void 0;d&&(k=this._replaceKeys(d,n.values))&&f.add(k);var g=void 0,p=!1;if(m){g=this._replaceKeys(m,n.values);switch(c){case 2:g=
g.toLowerCase();break;case 1:g=g.toUpperCase()}h._bidiEngine.hasBidiChar(g)&&(p=void 0,p="rtl"===h._bidiEngine.checkContextual(g)?"IDNNN":"ICNNN",g=h._bidiEngine.bidiTransform(g,p,"VLYSN"),p=!0);n=g.length;if(0<n){var l=b[C];l||(l=b[C]=new Set);for(var r=0;r<n;r++){var y=g.charCodeAt(r);l.add(y)}}}if(k||g)n=new L,n.sprite=k,n.label=g,n.rtl=p,n.geometry=t,e.push(n)}}this._symbolFeatures=e};h.prototype.processFeatures=function(a,f){a&&a.setExtent(this.layerExtent);var b=this.layer,c=this.zoom,e=this._isLinePlacement=
1===b.getLayoutValue("symbol-placement",c),d=this._avoidEdges=b.getLayoutValue("symbol-avoid-edges",c)&&!e,m=8*b.getLayoutValue("symbol-spacing",c),C=b.getLayoutValue("icon-image",c),q=b.getLayoutValue("text-field",c),u=this._workerTileHandler,n;C&&(this._markerLayout=new E.IconLayout(b,c,e),n=u.getSpriteItems());var t,k;if(q){var g=this._textLayout=new E.TextLayout(b,c,e);t=void 0;g.font&&g.font.length&&(t=g.font[0]);k=.5;switch(g.anchor){case 5:case 1:case 7:k=0;break;case 6:case 2:case 8:k=1}b=
.5;switch(g.anchor){case 5:case 3:case 6:b=0;break;case 7:case 4:case 8:b=1}c=.5;switch(g.justify){case 0:c=0;break;case 2:c=1}var C=24*g.letterSpacing,q=e?0:24*g.maxWidth,p=24*g.lineHeight,g=[24*g.offset[0],24*g.offset[1]];t=u.getGlyphItems(t);k=new I(t,q,p,C,g,k,b,c)}this._markerVertexStart=this._markerVertexBuffer.index;this._markerTriangleElementsStart=this._markerIndexBuffer.index;this._textVertexStart=this._textVertexBuffer.index;this._textTriangleElementsStart=this._textIndexBuffer.index;this._textTriangleElementsNum=
this._markerTriangleElementsNum=0;this._markerMap.clear();this._symbolInstances=u=[];this._glyphItems=t;b=this._textLayout;c=1;b&&b.size&&(c=b.size/24);C=b?b.maxAngle*w.C_DEG_TO_RAD:0;q=b?8*b.size:0;p=0;for(g=this._symbolFeatures;p<g.length;p++){var l=g[p],r=void 0;l.sprite&&(r=n[l.sprite]);var y=void 0,x=l.label,v=0;if(x&&(y=k.getShaping(x,l.rtl))&&0<y.length){for(var v=1E30,x=-1E30,A=0,D=y;A<D.length;A++)var B=D[A],v=Math.min(v,B.x),x=Math.max(x,B.x);v=(x-v+48)*c*8}x=0;for(l=l.geometry;x<l.length;x++)for(A=
l[x],B=void 0,e?(y&&0<y.length&&b&&b.size&&h._smoothVertices(A,8*b.size*(2+Math.min(2,4*Math.abs(b.offset[1])))),B=h._findAnchors(A,m,v)):B=[new F.Anchor(A[0].x,A[0].y)],D=0;D<B.length;D++){var z=B[D];0>z.x||4096<z.x||0>z.y||4096<z.y||e&&0<v&&0===b.rotationAlignment&&!h._honorsTextMaxAngle(A,z,v,C,q)||u.push(new M(y,A,r,z))}}u.sort(K);for(e=0;e<u.length;e++)this._processFeature(u[e],t,d)};h.prototype.updateSymbols=function(){this._markerVertexStart=this._markerVertexBuffer.index;this._markerTriangleElementsStart=
this._markerIndexBuffer.index;this._textVertexStart=this._textVertexBuffer.index;this._textTriangleElementsStart=this._textIndexBuffer.index;this._textTriangleElementsNum=this._markerTriangleElementsNum=0;this._markerMap.clear();for(var a=this._glyphItems,f=this._avoidEdges,b=0,c=this._symbolInstances;b<c.length;b++)this._processFeature(c[b],a,f)};h.prototype._replaceKeys=function(a,f){return a.replace(/{([^{}]+)}/g,function(a,c){return c in f?f[c]:""})};h.prototype._processFeature=function(a,f,b){var c=
a.line,e=a.iconMosaicItem,d=a.shaping,m=a.anchor,C=(a=this._markerLayout)&&!!e,q=!0,h=1;C&&(h=a.size/(1/this._markerRatio)*8,q=a.optional||!e);var n=this._textLayout,t=n&&d&&0<d.length,k;k=1;var g=!0;t&&(k=n.size/24,k*=8,g=n.optional||!d||0===d.length);var p=new B.Point(0,-17),l;if(C){l=this._placementEngine.getIconPlacement(m,e,h,c,a,b);if(l.footprint.minzoom===w.C_INFINITY&&!q)return;m.minzoom>l.footprint.minzoom&&(l.footprint.minzoom=m.minzoom)}var r;if(t&&(r=this._placementEngine.getTextPlacement(m,
p,d,f,k,c,n,b))){if(r.footprint.minzoom===w.C_INFINITY&&!g)return;m.minzoom>r.footprint.minzoom&&(r.footprint.minzoom=m.minzoom)}if(!g&&!q||!q&&r&&r.footprint.minzoom!==w.C_INFINITY||!g&&l&&l.footprint.minzoom!==w.C_INFINITY)f=Math.max(l.footprint.minzoom,r.footprint.minzoom),l.footprint.minzoom=f,r.footprint.minzoom=f;r&&r.footprint.minzoom!==w.C_INFINITY&&(n.ignorePlacement||this._placementEngine.add(r),this._addPlacedSymbols(r.shapes,r.footprint.minzoom,this.zoom,!1));l&&l.footprint.minzoom!==
w.C_INFINITY&&(a.ignorePlacement||this._placementEngine.add(l),this._addPlacedSymbols(l.shapes,l.footprint.minzoom,this.zoom,!0,e.page))};h.prototype._addPlacedSymbols=function(a,f,b,c,e){void 0===e&&(e=-1);f=Math.max(b+w.log2(f),0);for(var d=0;d<a.length;d++){var m=a[d],h=Math.max(b+w.log2(m.minzoom),f),q=Math.min(b+w.log2(m.maxzoom),25);if(!(q<=h)){var u=m.tl,n=m.tr,t=m.bl,k=m.br,g=m.mosaicRect,p=-m.labelAngle,m=m.anchor,l=c?this._markerVertexBuffer:this._textVertexBuffer,r=c?this._markerIndexBuffer:
this._textIndexBuffer,y=l.index,x=g.x,v=g.y,A=x+g.width,g=v+g.height;l.add(m.x,m.y,u.x,u.y,x,v,p,h,q,f);l.add(m.x,m.y,n.x,n.y,A,v,p,h,q,f);l.add(m.x,m.y,t.x,t.y,x,g,p,h,q,f);l.add(m.x,m.y,k.x,k.y,A,g,p,h,q,f);r.add(y+0,y+1,y+2);r.add(y+1,y+2,y+3);c?(this._markerMap.has(e)?this._markerMap.get(e)[1]+=6:this._markerMap.set(e,[this._markerTriangleElementsStart+this._markerTriangleElementsNum/3,6]),this._markerTriangleElementsNum+=6):this._textTriangleElementsNum+=6}}};h._findAnchors=function(a,f,b){f+=
b;for(var c=0,e=a.length-1,d=0;d<e;d++)c+=B.Point.distance(a[d],a[d+1]);d=.5*(b||f);if(c<=d)return[];b=d/c;f=c/Math.max(Math.round(c/f),1);for(var c=0,e=-f/2,m=[],h=a.length-1,d=0;d<h;d++){for(var q=a[d],u=a[d+1],n=u.x-q.x,t=u.y-q.y,k=Math.sqrt(n*n+t*t),g=void 0;e+f<c+k;){var e=e+f,p=(e-c)/k,l=w.interpolate(q.x,u.x,p),p=w.interpolate(q.y,u.y,p);void 0===g&&(g=Math.atan2(t,n));m.push(new F.Anchor(l,p,g,d,b))}c+=k}return m};h.deviation=function(a,f,b){return Math.atan2((f.x-a.x)*(b.y-f.y)-(f.y-a.y)*
(b.x-f.x),(f.x-a.x)*(b.x-f.x)+(f.y-a.y)*(b.y-f.y))};h._honorsTextMaxAngle=function(a,f,b,c,e){var d=0;b/=2;for(var m=new B.Point(f.x,f.y),h=f.segment+1;d>-b;){--h;if(0>h)return!1;d-=B.Point.distance(a[h],m);m=a[h]}d+=B.Point.distance(a[h],a[h+1]);f=[];for(var m=0,q=a.length;d<b;){var u=a[h],n=void 0;do{++h;if(h===q)return!1;n=a[h]}while(n.isEqual(u));var t=h,k=void 0;do{++t;if(t===q)return!1;k=a[t]}while(k.isEqual(n));u=this.deviation(u,n,k);f.push({deviation:u,distToAnchor:d});for(m+=u;d-f[0].distToAnchor>
e;)m-=f.shift().deviation;if(Math.abs(m)>c)return!1;d+=B.Point.distance(n,k)}return!0};h._smoothVertices=function(a,f){if(!(0>=f)){var b=a.length;if(!(3>b)){var c=[],e=0;c.push(0);for(var d=1;d<b;d++)e+=B.Point.distance(a[d],a[d-1]),c.push(e);f=Math.min(f,.2*e);e=[];e.push(a[0].x);e.push(a[0].y);var h=a[b-1].x,w=a[b-1].y,d=B.Point.sub(a[0],a[1]);d.normalize();a[0].x+=f*d.x;a[0].y+=f*d.y;d.assignSub(a[b-1],a[b-2]);d.normalize();a[b-1].x+=f*d.x;a[b-1].y+=f*d.y;for(d=1;d<b;d++)c[d]+=f;c[b-1]+=f;for(var q=
.5*f,d=1;d<b-1;d++){for(var u=0,n=0,t=0,k=d-1;0<=k&&!(c[k+1]<c[d]-q);k--){var g=q+c[k+1]-c[d],p=c[k+1]-c[k],l=c[d]-c[k]<q?1:g/p;if(1E-6>Math.abs(l))break;var r=l*l,y=l*g-.5*r*p,x=l*p/f,v=a[k+1],A=a[k].x-v.x,z=a[k].y-v.y,u=u+x/y*(v.x*l*g+.5*r*(g*A-p*v.x)-r*l*p*A/3),n=n+x/y*(v.y*l*g+.5*r*(g*z-p*v.y)-r*l*p*z/3),t=t+x}for(k=d+1;k<b&&!(c[k-1]>c[d]+q);k++){g=q-c[k-1]+c[d];p=c[k]-c[k-1];l=c[k]-c[d]<q?1:g/p;if(1E-6>Math.abs(l))break;r=l*l;y=l*g-.5*r*p;x=l*p/f;v=a[k-1];A=a[k].x-v.x;z=a[k].y-v.y;u+=x/y*(v.x*
l*g+.5*r*(g*A-p*v.x)-r*l*p*A/3);n+=x/y*(v.y*l*g+.5*r*(g*z-p*v.y)-r*l*p*z/3);t+=x}e.push(u/t);e.push(n/t)}e.push(h);e.push(w);for(k=d=0;d<b;d++)a[d].x=e[k++],a[d].y=e[k++]}}};return h}(H);z._bidiEngine=new J;return z});