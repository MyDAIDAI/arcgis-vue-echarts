// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.20/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/vectorTiles/WorkerTile","require exports dojo/Deferred ../../core/promiseUtils ../../core/executeAsync ./VertexMemoryBuffer ./IndexMemoryBuffer ./TileParser ./BackgroundBucket ./FillBucket ./LineBucket ./SymbolBucket ./Placement ./GeometryUtils".split(" "),function(I,J,B,r,C,e,h,D,E,F,G,H,u,v){return function(){function f(c,e,a,k){void 0===k&&(k=0);this.rotation=0;this._symbolBuckets=[];this.tileKey=c;this.refKey=e;this._workerTileHandler=a;this.status=0;this.rotation=
k;this.placementEngine=new u.PlacementEngine(v.C_DEG_TO_RAD*k)}f.prototype.setDataAndParse=function(c,f){var a=this;this.polygonVertexBuffer=new e.PolygonMemoryBuffer;this.polygonOutlineVertexBuffer=new e.PolygonOutlineMemoryBuffer;this.polygonIndexBuffer=new h.TriangleElementMemoryBuffer;this.polygonOutlineIndexBuffer=new h.TriangleElementMemoryBuffer;this.lineVertexBuffer=new e.LineMemoryBuffer;this.lineIndexBuffer=new h.TriangleElementMemoryBuffer;this.lineJoinVertexBuffer=new e.LineJoinMemoryBuffer;
this.markerVertexBuffer=new e.SymbolMemoryBuffer;this.markerIndexBuffer=new h.TriangleElementMemoryBuffer;this.textVertexBuffer=new e.SymbolMemoryBuffer;this.textIndexBuffer=new h.TriangleElementMemoryBuffer;var k=new B(function(c){a.status=6});this._parse(c,f).then(function(c){a.placementEngine=null;for(var e=new Uint32Array([2,a.polygonVertexBuffer.sizeInBytes,3,a.polygonOutlineVertexBuffer.sizeInBytes,6,a.polygonIndexBuffer.sizeInBytes,7,a.polygonOutlineIndexBuffer.sizeInBytes,0,a.lineVertexBuffer.sizeInBytes,
8,a.lineIndexBuffer.sizeInBytes,1,a.lineJoinVertexBuffer.sizeInBytes,4,a.markerVertexBuffer.sizeInBytes,9,a.markerIndexBuffer.sizeInBytes,5,a.textVertexBuffer.sizeInBytes,10,a.textIndexBuffer.sizeInBytes]),d=[],f=c.length,l=0;l<f;l++){var b=c[l];b instanceof F?(d.push(b.layerIndex),d.push(1),d.push(b.polygonIndexStart),d.push(b.polygonIndexCount),d.push(b.polygonOutlineIndexStart),d.push(b.polygonOutlineIndexCount)):b instanceof G?(d.push(b.layerIndex),d.push(2),d.push(b.triangleIndexStart),d.push(b.triangleIndexCount),
d.push(b.connectorStart),d.push(b.connectorCount)):b instanceof H?(d.push(b.layerIndex),d.push(3),d.push(0===b.textIndexCount?0:b.textIndexStart),d.push(b.textIndexCount),d.push(b.sdfMarker?1:0),b=b.markerPageMap,d.push(b.size),b.forEach(function(a,b){d.push(b);d.push(a[0]);d.push(a[1])})):b instanceof E&&(d.push(b.layerIndex),d.push(0))}c=new Uint32Array(d);var f=a.polygonVertexBuffer.toBuffer(),l=a.polygonOutlineVertexBuffer.toBuffer(),b=a.polygonIndexBuffer.toBuffer(),h=a.polygonOutlineIndexBuffer.toBuffer(),
w=a.lineVertexBuffer.toBuffer(),x=a.lineIndexBuffer.toBuffer(),y=a.lineJoinVertexBuffer.toBuffer(),g=a.markerVertexBuffer.toBuffer(),z=a.markerIndexBuffer.toBuffer(),A=a.textVertexBuffer.toBuffer(),m=a.textIndexBuffer.toBuffer();a.placementEngine=null;a.polygonVertexBuffer=null;a.polygonIndexBuffer=null;a.polygonOutlineVertexBuffer=null;a.polygonOutlineIndexBuffer=null;a.lineVertexBuffer=null;a.lineIndexBuffer=null;a.lineJoinVertexBuffer=null;k.resolve({data:{bufferDataInfo:e.buffer,bucketDataInfo:c.buffer,
bufferData:[f,l,b,h,w,x,y,g,z,A,m]},buffers:[f,b,l,h,w,x,y,g,z,A,m,e.buffer,c.buffer]})});return k.promise};f.prototype.addBucket=function(c){this._symbolBuckets.push(c)};f.prototype.updateSymbols=function(c){var f=this,a=this._symbolBuckets;if(!a)return r.resolve({data:null});this.rotation=c;var k=new u.PlacementEngine(c/256*360*v.C_DEG_TO_RAD),n=new e.SymbolMemoryBuffer,p=new h.TriangleElementMemoryBuffer,d=new e.SymbolMemoryBuffer,q=new h.TriangleElementMemoryBuffer,l=[],b=a.length,t=0;return C(function(){if(6===
f.status)return!0;if(t<b){var c=a[t++].copy(n,p,d,q,k);c&&(l.push(c),c.updateSymbols())}return t>=b},5).then(function(){if(6===f.status||0===n.sizeInBytes&&0===p.sizeInBytes&&0===d.sizeInBytes&&0===q.sizeInBytes)return{data:null};var a=new Uint32Array([4,n.sizeInBytes,9,p.sizeInBytes,5,d.sizeInBytes,10,q.sizeInBytes]),c=[];b=l.length;for(var e=0;e<b;e++){var g=l[e];c.push(g.layerIndex);c.push(3);c.push(0===g.textIndexCount?0:g.textIndexStart);c.push(g.textIndexCount);c.push(g.sdfMarker?1:0);g=g.markerPageMap;
c.push(g.size);g.forEach(function(a,b){c.push(b);c.push(a[0]);c.push(a[1])})}var e=new Uint32Array(c),g=n.toBuffer(),h=p.toBuffer(),k=d.toBuffer(),m=q.toBuffer();return{data:{bufferDataInfo:a.buffer,bucketDataInfo:e.buffer,bufferData:[g,h,k,m]},buffers:[g,h,k,m,a.buffer,e.buffer]}}).otherwise(function(a){return r.resolve({data:null})})};f.prototype.setObsolete=function(){this.status=6};f.prototype.getLayers=function(){return this._workerTileHandler.getLayers()};f.prototype.getWorkerTileHandler=function(){return this._workerTileHandler};
f.prototype._parse=function(c,e){return c&&0!==c.byteLength?(new D(c,this,e)).parse():r.resolve([])};return f}()});