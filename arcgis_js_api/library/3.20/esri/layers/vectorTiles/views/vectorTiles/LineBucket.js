// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.20/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/vectorTiles/LineBucket","require exports ../../core/tsSupport/extendsHelper ../../core/tsSupport/decorateHelper ./Bucket ./style/StyleLayer ./LineTess".split(" "),function(t,u,p,v,q,r,e){return function(n){function f(a,d,b,c,g){a=n.call(this,a,d)||this;a.extrudeVectorsDoubleBuffer=[e.allocExtrudeVectors(),e.allocExtrudeVectors()];a.recycledTriangleBridge=e.allocTriangles(20);a.recycledTrianglePie=e.allocTriangles(20);a.lineVertexBuffer=b;a.lineIndexBuffer=c;return a}
p(f,n);Object.defineProperty(f.prototype,"triangleIndexStart",{get:function(){return this.triangleElementsStart},enumerable:!0,configurable:!0});Object.defineProperty(f.prototype,"triangleIndexCount",{get:function(){return this.triangleElementsCount},enumerable:!0,configurable:!0});Object.defineProperty(f.prototype,"connectorStart",{get:function(){return 0},enumerable:!0,configurable:!0});Object.defineProperty(f.prototype,"connectorCount",{get:function(){return 0},enumerable:!0,configurable:!0});
f.prototype.assignBufferInfo=function(a){a.triangleElementsStart=this.triangleElementsStart;a.triangleElementsCount=this.triangleElementsCount};f.prototype.processFeatures=function(a,d){this.triangleElementsStart=this.lineIndexBuffer.index;this.triangleElementsCount=0;a&&a.setExtent(this.layerExtent);for(var b=new r.LineLayout(this.layer,this.zoom),c=0,g=this._features;c<g.length;c++){var e=g[c].getGeometry(a);this._processFeature(b,e)}};f.prototype._processFeature=function(a,d){if(d)for(var b=d.length,
c=0;c<b;c++)this._processGeometry(d[c],a)};f.prototype._processGeometry=function(a,d){if(!(2>a.length)){var b=a[0],c=a[a.length-1],g=c.x-b.x,b=c.y-b.y,g=1E-6>g*g+b*b;if(!(2>a.length)){b=a[0];for(c=1;c<a.length;){var h=a[c].x-b.x,l=a[c].y-b.y;1E-6>h*h+l*l?a.splice(c,1):(b=a[c],++c)}if(!(2>a.length)){this.vertices=a;this.isClosed=g;this.cap=d.cap;this.join=d.join;this.almostParallelRads=.05;this.veryShallowRads=.1;this.miterSafeRads=e.MITER_SAFE_RADS;this.miterLimitMag=Math.min(d.miterLimit,e.SYSTEM_MAG_LIMIT);
this.roundLimitRads=Math.min(d.roundLimit,.5);this.newRoundJoinsSafeRads=2.3;for(var b=this.lineIndexBuffer.index,c=0,k=void 0,h=0;h<a.length;++h){var f=a[h],l=k===this.extrudeVectorsDoubleBuffer[h%2]?this.extrudeVectorsDoubleBuffer[(h+1)%2]:this.extrudeVectorsDoubleBuffer[h%2];this._computeExtrudeVectors(l,h);this._writeGPUVertices(f.x,f.y,c,l);!l.capCenter||g&&h===a.length-1||this._writeGPUPieElements(l);k&&this._writeGPUBridgeElements(k,l);h<a.length-1&&(k=a[h+1],f=e.length([k.x-f.x,k.y-f.y]),
c+=f);k=l}this.triangleElementsCount+=3*(this.lineIndexBuffer.index-b)}}}};f.prototype._computeExtrudeVectors=function(a,d){var b=this.vertices,c=this.isClosed,g=b[d],h=[void 0,void 0],f=[void 0,void 0];if(0<d&&d<b.length-1){var k=b[(d+b.length-1)%b.length],m=b[(d+1)%b.length];e.normalize(h,[g.x-k.x,g.y-k.y]);e.normalize(f,[m.x-g.x,m.y-g.y])}else if(0===d)m=b[(d+1)%b.length],e.normalize(f,[m.x-g.x,m.y-g.y]),c?(k=b[b.length-2],e.normalize(h,[g.x-k.x,g.y-k.y])):h=f;else if(d===b.length-1)k=b[(d+b.length-
1)%b.length],e.normalize(h,[g.x-k.x,g.y-k.y]),c?(k=b[1],e.normalize(f,[k.x-g.x,k.y-g.y])):f=h;else throw Error("Parameter i out of range.");c||0!==d?c||d!==b.length-1?this._computeJoinExtrudeVectors(a,h,f):this._computeCapExtrudeVectors(a,h,f,e.CapPosition.END):this._computeCapExtrudeVectors(a,h,f,e.CapPosition.START)};f.prototype._computeCapExtrudeVectors=function(a,d,b,c){if(0===this.cap)e.buttCap(a,d,b);else if(1===this.cap)e.roundCap(a,d,b,c,e.getNumberOfSlices(Math.PI));else if(2===this.cap)e.squareCap(a,
d,b,c);else throw Error("Unknown cap type!");};f.prototype._computeJoinExtrudeVectors=function(a,d,b){var c=e.getRads(d,b);if(c>Math.PI-this.almostParallelRads)e.rectJoin(a,d,b);else if(2===this.join||c<this.veryShallowRads)c<this.almostParallelRads?e.fastMiterJoin(a,d,b):c<this.miterSafeRads?e.miterJoin(a,d,b):e.bevelJoin(a,d,b,this.miterLimitMag);else if(0===this.join)e.bevelJoin(a,d,b,1);else if(1===this.join){var g=e.getNumberOfSlices(c);c<this.newRoundJoinsSafeRads?2>g||c<this.roundLimitRads?
e.bevelJoin(a,d,b,1):e.roundJoin(a,d,b,g):e.unitRoundJoin(a,d,b,g)}};f.prototype._writeGPUVertices=function(a,d,b,c){for(var e=0;e<c.vectors.count;++e){var f=this.lineVertexBuffer.add(a,d,c.vectors.items[e].vector[0],c.vectors.items[e].vector[1],0,c.vectors.items[e].side,b);c.vectors.items[e].base=f}};f.prototype._writeGPUBridgeElements=function(a,d){e.bridge(this.recycledTriangleBridge,a,d,!1);for(var b=0;b<this.recycledTriangleBridge.count;++b){var c=this.recycledTriangleBridge.items[b];this.lineIndexBuffer.add(c.v1.base,
c.v2.base,c.v3.base)}};f.prototype._writeGPUPieElements=function(a){e.pie(this.recycledTrianglePie,a);for(a=0;a<this.recycledTrianglePie.count;++a){var d=this.recycledTrianglePie.items[a];this.lineIndexBuffer.add(d.v1.base,d.v2.base,d.v3.base)}};return f}(q)});