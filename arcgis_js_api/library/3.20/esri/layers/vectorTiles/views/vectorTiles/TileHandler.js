// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.20/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/vectorTiles/TileHandler","require exports module dojo/Deferred dojo/promise/all ../../core/workers ../../core/promiseUtils ../../core/requireUtils ../../request ../2d/layers/support/TileKey ./TileIndex ./SpriteMosaic ./SpriteSource ./GlyphMosaic ./GlyphSource ./VectorTileDisplayObject ./GeometryUtils".split(" "),function(q,D,r,t,l,u,h,v,m,k,w,x,y,z,A,B,C){return function(){function b(a,c,d,e){void 0===e&&(e=!1);this.devicePixelRatio=d;this.allowUpdates=e;this._tileIndex=
this._connection=this._glyphMosaic=this._spriteMosaic=null;this._ongoingRequests={};this._vectorTileLayer=a;this._styleRepository=a.styleRepository;this._requestUpdate=c}b.prototype.destroy=function(){this.stop();this._vectorTileLayer=this._requestUpdate=this._styleRepository=null};Object.defineProperty(b.prototype,"spriteMosaic",{get:function(){return this._spriteMosaic},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"glyphMosaic",{get:function(){return this._glyphMosaic},enumerable:!0,
configurable:!0});b.prototype.start=function(){var a=this;this.stop();var c=this._styleRepository,d=new y(c.sprite,this.devicePixelRatio);d.devicePixelRatio=devicePixelRatio;var e=d.load().then(function(){a._spriteMosaic=new x(1024,1024,250);a._spriteMosaic.setSpriteSource(d)}),b=new A(c.glyphs);this._glyphMosaic=new z(1024,1024,b);var f=this._fetchTileMap(this._vectorTileLayer.tileIndexUrl),g=u.open(this,v.getAbsMid("./WorkerTileHandler",q,r)).then(function(d){a._connection=d}),p=new t(function(a){e.isFulfilled()||
e.cancel();f.isFulfilled()||f.cancel();g.isFulfilled()||g.cancel()});l([e,f,g]).then(function(d){l(a._connection.broadcast("setLayers",c.styleJSON)).then(function(){p.resolve()})});return this._broadcastPromise=p.promise};b.prototype.stop=function(){this._broadcastPromise&&!this._broadcastPromise.isFulfilled()&&this._broadcastPromise.cancel();for(var a in this._ongoingRequests)this._ongoingRequests[a].cancel("cancel");this._connection&&(this._connection.close(),this._connection=null)};b.prototype.updateTile=
function(a,c){if(this.allowUpdates){if(!this._broadcastPromise.isFulfilled()||!this._connection)return h.reject(Error("no connection"));var d=Math.round(C.degToByte(c.state.rotation));if(a.rotation===d)return null;a.rotation=d;return this._connection.invoke("update",{key:a.id,rotation:d},[],{id:a.workerID}).then(function(d){a.updateSymbolData(d);return a})}};b.prototype.getVectorTileWithLRC=function(a,c,d,b){void 0===b&&(b=0);return this.getVectorTile(k.from(a,c,d,0),{state:{rotation:b}})};b.prototype.getVectorTile=
function(a,c){var d=this;if(!this._broadcastPromise.isFulfilled()||!this._connection)return h.reject(Error("no connection"));var b=this._vectorTileLayer.tileInfo,n=Math.round(c?c.state.rotation:0);if(b.lods.length<=a.level)return h.reject("Cannot create tile for the requested level");var f=this._tileIndex?this._tileIndex.dataKey(a):a;return f?this._getTileData(this._connection,a,f,n).then(function(c){if(!c||!c.tileData)return h.reject("No data");var e=b.size[0]*b.lods[a.level].resolution,g=b.origin,
k=g.x+a.col*e+a.world*d._vectorTileLayer.fullExtent.width,l=k+e,g=g.y-a.row*e,e=g-e;d._requestUpdate();return new B(a,f,[k,g,l,e],d._vectorTileLayer.tileInfo.size[1],4096,n,c.tileData,d._styleRepository,d._glyphMosaic,d.allowUpdates?c.workerId:-1,d._connection)}):h.reject(Error("no data"))};b.prototype.fetchTileData=function(a){a=k.pool.acquire(a);var c=this._vectorTileLayer.getTileUrl(a.level,a.row,a.col);k.pool.release(a);return m(c,{callbackParamName:"callback",responseType:"array-buffer"}).then(function(a){return{data:{protobuff:a.data},
buffers:[a.data]}})};b.prototype.getSprites=function(a){return h.resolve({data:{spriteItems:this._spriteMosaic.getSpriteItems(a.sprites)}})};b.prototype.getGlyphs=function(a){return this._glyphMosaic.getGlyphItems(a.tileID,a.font,a.codePoints).then(function(a){return{data:{glyphItems:a}}})};b.prototype.getStyleRepository=function(){return this._styleRepository};b.prototype.getTileIndex=function(){return this._tileIndex};b.prototype._getTileData=function(a,c,d,b){var e=this,f={id:null};if(a=this._ongoingRequests[c.id])return a;
a=this._connection.invoke("getTile",{key:c.id,refKey:d.id,rotation:b,cacheTile:this.allowUpdates},[],f).then(function(a){delete e._ongoingRequests[c.id];return{tileData:a,workerId:f.id}}).otherwise(function(a){delete e._ongoingRequests[c.id];e.allowUpdates&&e._connection.invoke("destructTileData",{key:c.id},[],f);return h.reject(a)});return this._ongoingRequests[c.id]=a};b.prototype._fetchTileMap=function(a){var b=this;return a?m(a,{callbackParamName:"callback",responseType:"json"}).then(function(a){b._tileIndex=
new w(a.data)}):null};return b}()});