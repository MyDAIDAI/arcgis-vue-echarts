// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.20/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/2d/engine/StageGL","require exports ../../../core/tsSupport/extendsHelper ./../math/vec2 ./../math/mat2d ./webgl/BitBlitRenderer ../../support/screenshotUtils ../../../core/promiseUtils ../math/common ./Container ../../webgl/RenderingContext ../../webgl/FramebufferObject ../../webgl/webgl-utils ../../webgl/Program ../../webgl/VertexArrayObject ../../webgl/BufferObject ./webgl/glShaderSnippets".split(" "),function(N,O,C,k,x,D,E,F,G,H,I,y,J,K,L,z,A){function B(k){return{budget:k.budget,
state:k.state,devicePixelRatio:k.devicePixelRatio,stationary:k.stationary}}var M={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"};return function(w){function g(){var a=null!==w&&w.apply(this,arguments)||this;a._clipData=new Float32Array(8);a._upperLeft=k.create();a._upperRight=k.create();a._lowerLeft=k.create();a._lowerRight=k.create();a._mat2=x.create();a._clipRendererInitialized=!1;return a}C(g,w);g.prototype.createElement=function(){var a=document.createElement("canvas");a.setAttribute("class",
"esri-display-object");return a};g.prototype.setElement=function(a){this.element=a};g.prototype.attach=function(a){this._resizeCanvas(a);var d=J.setupWebGL(this.element,{alpha:!0,antialias:!1,depth:!0,stencil:!0});this._renderingContext=new I(d[0]);this.attached=!0;this._cachedRenderParams=B(a);return w.prototype.attach.call(this,a)};g.prototype.detach=function(a){w.prototype.detach.call(this,a);this._cachedRenderParams=this._renderingContext=null};g.prototype.beforeRenderChildren=function(a,d){var b=
a.state;if(b.spatialReference&&(b.spatialReference._isWrappable?b.spatialReference._isWrappable():b.spatialReference.isWrappable)){var e=b.width,c=b.height,g=b.rotation,h=this._renderingContext,e=e*a.devicePixelRatio,c=c*a.devicePixelRatio,m=G.toRadian(g),f=Math.abs(Math.cos(m)),v=Math.abs(Math.sin(m)),p=Math.round(b.worldScreenWidth);if(Math.round(e*f+c*v)<=p)this._clipFrame=!1;else{this._clipFBO&&this._clipFBO.width===e&&this._clipFBO.height===c||(this._clipFBO=new y(h,{colorTarget:0,depthStencilTarget:3,
width:e,height:c}));var l=.5*e,q=.5*c,b=1/e,r=1/c,p=.5*p*a.devicePixelRatio,t=.5*(e*v+c*f),e=this._upperLeft,f=this._upperRight,v=this._lowerLeft,n=this._lowerRight;k.set(e,-p,-t);k.set(f,p,-t);k.set(v,-p,t);k.set(n,p,t);x.identity(this._mat2);x.translate(this._mat2,this._mat2,[l,q]);0!==g&&x.rotate(this._mat2,this._mat2,m);k.transformMat2d(e,e,this._mat2);k.transformMat2d(f,f,this._mat2);k.transformMat2d(v,v,this._mat2);k.transformMat2d(n,n,this._mat2);g=this._clipData;g.set([2*v[0]*b-1,2*(c-v[1])*
r-1,2*n[0]*b-1,2*(c-n[1])*r-1,2*e[0]*b-1,2*(c-e[1])*r-1,2*f[0]*b-1,2*(c-f[1])*r-1]);this._clipRendererInitialized||this._initializeClipRenderer(h);this._clipVBO.setData(g);h.bindFramebuffer(this._clipFBO);h.setDepthWriteEnabled(!0);h.setStencilWriteMask(255);h.setClearColor(0,0,0,0);h.setClearDepth(1);h.setClearStencil(0);h.clear(h.gl.COLOR_BUFFER_BIT|h.gl.DEPTH_BUFFER_BIT|h.gl.STENCIL_BUFFER_BIT);this._clipFrame=!0}}else this._clipFrame=!1};g.prototype.afterRenderChildren=function(a,d){if(this._clipFrame&&
this._clipRendererInitialized){var b=this._renderingContext;b.bindFramebuffer();b.bindVAO(this._clipVAO);b.bindProgram(this._clipStencilProgram);b.setDepthWriteEnabled(!1);b.setDepthTestEnabled(!1);b.setStencilTestEnabled(!0);b.setBlendingEnabled(!1);b.setColorMask(!1,!1,!1,!1);b.setStencilOp(7680,7680,7681);b.setStencilWriteMask(255);b.setStencilFunction(519,1,255);b.drawElements(4,6,5123,0);b.bindVAO();b.setColorMask(!0,!0,!0,!0);b.setBlendingEnabled(!0);b.setStencilWriteMask(255);b.setStencilFunction(514,
1,255);this._blitRenderer.render(b,this._clipFBO.colorTexture,9728,1);b.setStencilTestEnabled(!1)}};g.prototype.render=function(a){var d=this.element.style;this.visible?(d.display="block",d.opacity=""+this.opacity,this._resizeCanvas(a),w.prototype.render.call(this,a),this._cachedRenderParams=B(a)):d.display="none"};g.prototype.takeScreenshot=function(a){var d=this._cachedRenderParams.devicePixelRatio,b=d*this._cachedRenderParams.state.width,e=d*this._cachedRenderParams.state.height,c=0,g=0,h=b,m=
e,f=b,k=e;if(f=a.area)c=d*f.x,g=d*f.y,h=d*f.width,m=d*f.height;void 0!==a.width&&void 0!==a.height?(f=a.width/a.height,m*f<h?(f*=m,c+=Math.floor((h-f)/2),h=Math.floor(f)):(f=h/f,g+=Math.floor((m-f)/2),m=Math.floor(f)),f=a.width,k=a.height):(f=h,k=m);d=document.createElement("canvas");d.width=f;d.height=k;var p=d.getContext("2d"),l=new Uint8Array(h*m*4),q=this._renderingContext,r=y.create(q,{colorTarget:1,depthStencilTarget:3,width:b,height:e});q.bindFramebuffer(r);q.setViewport(0,0,b,e);this._cachedRenderParams.budget&&
this._cachedRenderParams.budget.reset(Number.MAX_VALUE);var t=this._cachedRenderParams,n=this._renderingContext.gl;this._renderingContext.setClearColor(0,0,0,0);this._renderingContext.setClearDepth(1);this._renderingContext.setClearStencil(0);this._renderingContext.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT|n.STENCIL_BUFFER_BIT);t.context=this._renderingContext;this.renderChildren(t);r.readPixels(c,e-(g+m),h,m,6408,5121,l);q.bindFramebuffer();q=p.getImageData(0,0,f,k);if(0!==c||0!==g||h!==b||m!==
e||f!==b||k!==e)E.resampleHermite(l,h,m,q.data,f,k,!0);else{for(var b=m-1,e=0,h=4*h,u=n=t=r=m=g=c=void 0;e<b;){n=e*h;u=b*h;for(c=0;c<h;c+=4)g=l[n+c],m=l[n+c+1],r=l[n+c+2],t=l[n+c+3],l[n+c]=l[u+c],l[n+c+1]=l[u+c+1],l[n+c+2]=l[u+c+2],l[n+c+3]=l[u+c+3],l[u+c]=g,l[u+c+1]=m,l[u+c+2]=r,l[u+c+3]=t;e++;b--}h=q.data;b=l.length;for(e=0;e<b;e++)h[e]=l[e]}p.putImageData(q,0,0);p=M[a.format?a.format.toLowerCase():"png"];l=1;void 0!==a.quality&&(l=a.quality/100);a=d.toDataURL(p,l);return F.resolve({dataURL:a,x:0,
y:0,width:f,height:k})};g.prototype.prepareChildrenRenderParameters=function(a){if(!this.attached||!this._renderingContext)return null;var d=this._renderingContext,b=d.gl;d.setDepthWriteEnabled(!0);d.setStencilWriteMask(255);d.setClearColor(0,0,0,0);d.setClearDepth(1);d.setClearStencil(0);d.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT|b.STENCIL_BUFFER_BIT);d.setViewport(0,0,this.element.width,this.element.height);d.setDepthWriteEnabled(!1);a.context=d;return a};g.prototype.attachChild=function(a,d){return a.attach(d)};
g.prototype.detachChild=function(a,d){return a.detach(d)};g.prototype.renderChild=function(a,d){return a.render(d)};g.prototype._resizeCanvas=function(a){var d=this.element,b=d.style,e=a.state,c=a.devicePixelRatio;a=e.width*c;c*=e.height;if(d.width!==a||d.height!==c)d.width=a,d.height=c,b.width=e.width+"px",b.height=e.height+"px"};g.prototype._initializeClipRenderer=function(a){if(this._clipRendererInitialized)return!0;this._blitRenderer=new D;var d={a_pos:0},b=new K(a,A.stencilVS,A.stencilFS,d);
if(!b)return!1;var e=z.createVertex(a,35040,32),c=new Uint16Array([0,1,2,2,1,3]),c=z.createIndex(a,35044,c);a=new L(a,d,{geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},{geometry:e},c);this._clipStencilProgram=b;this._clipVBO=e;this._clipVAO=a;return this._clipRendererInitialized=!0};return g}(H)});