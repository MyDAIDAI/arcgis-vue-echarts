// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.20/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/2d/layers/support/TileStrategy",["require","exports","../../../../core/LRUCache","./TileKey"],function(C,D,A,B){function n(d,a){d["delete"](a)}var w=[],r=[],k=[null,null],u=[],z=new A(30),d=new B(0,0,0,0);return function(){function g(a){this._tiles=new Map;this._tilesToRender=new Map;this._requests=new Map;this._updates=new Map;this._prevResolution=Number.POSITIVE_INFINITY;this._isStationary=!1;this.tileFilter=null;this.container=a.container;this.tileInfoView=
a.tileInfoView;this.requestUpdate=a.requestUpdate;this.fetchTile=a.fetchTile;this.tileFilter=a.tileFilter}g.prototype.destroy=function(){this._requests&&(this._requests.forEach(function(a){a.isFulfilled()||a.cancel()}),this._tilesToRender=this._requests=null)};Object.defineProperty(g.prototype,"updating",{get:function(){return 0!==this._requests.size||0!==this._updates.size},enumerable:!0,configurable:!0});g.prototype.update=function(a){var v=this,b=this._tiles,e=this._tilesToRender,c=this._requests,
l=this._updates,m=this.tileInfoView.getTileCoverage(a.state);if(m){var p=m.lodInfo.level,g=a.state.resolution>this._prevResolution;this._createCoverageList(w,m);var h=this.tileFilter?this.tileFilter([],w):w;e.clear();for(var q=0,x=0;x<h.length;x++){var f=h[x];if(b.has(f)){var t=b.get(f);e.set(f,t);q++;if(t.attached)continue}else z.has(f)?q++:c.has(f)||this._getTile(f,a);g||this._addParentTile(f,e)}var r=q===h.length;!this._isStationary&&a.stationary&&this.requestUpdate();this._isStationary=a.stationary;
var k=[],y=[];b.forEach(function(b,a){d.set(a);e.has(a)||(!g&&r||!v.tileInfoView.intersects(m,d)?(d.level>p||!v.tileInfoView.intersects(m,d))&&k.push(a):y.push(a))});for(t=0;t<y.length;t++)f=y[t],e.set(f,b.get(f));for(a=0;a<k.length;a++)f=k[a],l.has(f)&&(l.get(f).cancel(f),n(l,f)),t=b.get(f),t.dispose(),n(b,f);this.container.removeAllTiles();e.forEach(function(b){return v.container.addTile(b)});c.forEach(function(b,a){d.set(a);if(d.level>p||!v.tileInfoView.intersects(m,d))b.cancel(),u.push(a)});for(b=
0;b<u.length;b++)f=u[b],n(c,f);u.length=0}};g.prototype.updateTiles=function(a,d){var b=this;this._tilesToRender.forEach(function(e,c){if(e.attached){var l=a(e,d);l&&(b._updates.has(c)&&(b._updates.get(c).cancel(),n(b._updates,c)),l.then(function(a){n(b._updates,c);b._tilesToRender.has(c)&&b._tilesToRender.set(c,a);b.requestUpdate()}).otherwise(function(a){n(b._updates,c);b.requestUpdate();if(a&&"cancel"!==a.dojoType)throw a;}),b._updates.set(c,l))}})};g.prototype._addParentTile=function(a,d){this._getAvailableParentTile(k,
a);k[0]&&!d.has(k[0])&&d.set(k[0],k[1])};g.prototype._getTile=function(a,g){var b=this,e=this.fetchTile(a,g).then(function(c){d.set(a);b.tileInfoView.getTileTopLeft(c.topLeft,d);b.tileInfoView.getTileBottomRight(c.bottomRight,d);c.resolution=b.tileInfoView.getTileResolution(d);b._tiles.set(a,c);n(b._requests,a);b.requestUpdate()}).otherwise(function(c){c&&"no data"===c.message&&z.insert(a,a);n(b._requests,a)});this._requests.set(a,e)};g.prototype._getAvailableParentTile=function(a,d){a[0]=null;a[1]=
null;for(var b=d;b=this.tileInfoView.getTileParentId(b);)if(this._tiles.has(b)){a[0]=b;a[1]=this._tiles.get(b);break}return a};g.prototype._createCoverageList=function(a,g){a.length=0;r.length=0;var b=g.spans;if(0!==b.length){for(var e=0,c=0,l=Infinity,m=-Infinity,e=b[0].row,c=b[b.length-1].row,p=0;p<b.length;p++)for(var k=b[p],h=k.colFrom,q=k.colTo;h<=q;h++)l=Math.min(l,h),m=Math.max(m,h);p=g.lodInfo;k=p.level;c=e+Math.floor(.5*(c-e));l+=Math.floor(.5*(m-l));h=c-e;0<=h&&h<b.length&&(d.set(k,c,p.normalizeCol(l),
p.getWorldForColumn(l)),r.push({dist:0,id:d.id}));for(var n,e=0;e<b.length;e++)for(q=b[e],m=q.row,h=q.colFrom,q=q.colTo;h<=q;h++)n=Math.abs(h-l)+Math.abs(m-c),0!==n&&(d.set(k,m,p.normalizeCol(h),p.getWorldForColumn(h)),r.push({dist:n,id:d.id}));r.sort(function(a,b){return a.dist-b.dist});for(b=0;b<r.length;b++)a.push(r[b].id)}};return g}()});